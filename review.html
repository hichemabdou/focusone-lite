<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Focus.One — Quarterly Review</title>
<style>
  :root{--line:#e2e8f0;--muted:#64748b;--green:#22c55e;--violet:#8b5cf6;--amber:#f59e0b}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f7f9fc}
  .wrap{max-width:900px;margin:24px auto;padding:0 16px}
  header{padding:14px 20px;background:#fff;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
  a.btn,button.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;text-decoration:none;color:#0f172a}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:16px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .g6{grid-column:span 6} .g12{grid-column:span 12}
  label{font-size:12px;color:#334155;margin-bottom:6px;display:block}
  input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#f9fafb}
  .pill{display:inline-block;padding:4px 10px;border-radius:9999px;font-weight:700}
  .kpi{display:flex;gap:10px;flex-wrap:wrap}
  .kpi .pill.green{background:#22c55e;color:#fff}
  .kpi .pill.violet{background:#8b5cf6;color:#fff}
  .kpi .pill.amber{background:#f59e0b;color:#fff}
</style>
</head>
<body>
<header>
  <a class="btn" href="index.html">← Back to Goals</a>
  <div style="font-weight:800">Quarterly Review</div>
</header>
<div class="wrap">
  <div class="card">
    <div class="grid">
      <div class="g6">
        <label>Quarter start</label>
        <input id="qStart" type="date">
      </div>
      <div class="g6">
        <label>Quarter end</label>
        <input id="qEnd" type="date">
      </div>
      <div class="g12">
        <label>Notes</label>
        <textarea id="notes" rows="5" placeholder="What moved the needle? What slipped? Focus for next quarter?"></textarea>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <span class="pill green">Completion: <span id="k1">–</span>%</span>
      <span class="pill violet">On-time: <span id="k2">–</span>%</span>
      <span class="pill amber">Priority-weighted: <span id="k3">–</span>%</span>
      <span class="pill">Score: <span id="k4">–</span></span>
    </div>
  </div>

  <div class="card">
    <button class="btn" id="compute">Compute</button>
    <button class="btn" id="download">Download .ics</button>
  </div>
</div>

<script>
const KEY='focusone_goals';
const $=s=>document.querySelector(s);
function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||[] }catch(e){ return [] } }
function weight(p){ return p==='low'?1:p==='medium'?2:p==='high'?3:5; }

function compute(){
  const qs=$('#qStart').value, qe=$('#qEnd').value;
  if(!qs||!qe) return alert('Select period');
  const list=load().filter(g=>g.start_date && g.due_date && new Date(g.due_date)>=new Date(qs) && new Date(g.start_date)<=new Date(qe));
  const total=list.length, done=list.filter(g=>g.status==='done').length;
  const completion = Math.round(total? done/total*100:0);
  const onTime = done? 100:0;
  const denom=list.reduce((a,g)=>a+weight(g.priority),0);
  const num=list.reduce((a,g)=>a+(g.status==='done'?weight(g.priority):0),0);
  const pwc=Math.round(denom? num/denom*100:0);
  const score=Math.round(0.5*completion+0.3*onTime+0.2*pwc);
  $('#k1').textContent=completion; $('#k2').textContent=onTime; $('#k3').textContent=pwc; $('#k4').textContent=score;
}

function ics(){
  const qs=$('#qStart').value, qe=$('#qEnd').value; if(!qs||!qe) return alert('Select period');
  const uid=Math.random().toString(36).slice(2); const dt=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
  const ics=[
    'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Focus.One//Quarterly Review//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH',
    'BEGIN:VEVENT',`UID:review-${uid}@focusone`,`DTSTAMP:${dt}`,
    `DTSTART;VALUE=DATE:${qs.replaceAll('-','')}`,`DTEND;VALUE=DATE:${qe.replaceAll('-','')}`,
    'SUMMARY:Quarterly Review - Focus.One','END:VEVENT','END:VCALENDAR'
  ].join('\r\n');
  const blob=new Blob([ics],{type:'text/calendar'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='focusone-review.ics'; a.click(); URL.revokeObjectURL(url);
}

document.getElementById('compute').onclick=compute;
document.getElementById('download').onclick=ics;
['qStart','qEnd'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('change',()=>el.blur())});

// suggest defaults (this quarter)
const now=new Date(); const q=Math.floor(now.getMonth()/3); const start=new Date(now.getFullYear(), q*3, 1);
const end=new Date(now.getFullYear(), q*3+3, 0);
document.getElementById('qStart').value=start.toISOString().slice(0,10);
document.getElementById('qEnd').value=end.toISOString().slice(0,10);
compute();
</script>
</body>
</html>
