<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Focus.One Lite</title>

<!-- Timeline -->
<link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css">
<script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>

<!-- Flatpickr (calendars + locale) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/en.js"></script>

<!-- Intro.js (onboarding) -->
<link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
<script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

<!-- Quill (rich notes) -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>

<!-- Firebase (optional cloud sync) -->
<script type="module">
/* ==== Optional Firebase: paste your config or leave blank for local-only ==== */
const FB = {
  enabled: false,   // set true after you paste your config below
  config: {
    // apiKey: "PASTE_HERE",
    // authDomain: "PASTE_HERE",
    // projectId: "PASTE_HERE",
    // storageBucket: "PASTE_HERE",
    // messagingSenderId: "PASTE_HERE",
    // appId: "PASTE_HERE"
  }
};
window.__FB__ = FB;
</script>

<style>
  :root{
    --bg:#f6f7fb; --fg:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
    --primary:#0ea5e9; --primary-2:#60a5fa; --pill:#eef2f7;
    --green:#22c55e; --violet:#8b5cf6; --amber:#f59e0b; --red:#ef4444; --slate:#94a3b8;
    --pattern:repeating-linear-gradient(45deg, rgba(255,255,255,.25) 0 8px, rgba(0,0,0,.15) 8px 16px);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --fg:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --card:#0f172a;
    --pill:#0b1624; --primary:#22a1f1; --primary-2:#3db1fb;
  }
  *{box-sizing:border-box}
  body{
    font-family:ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background:var(--bg); color:var(--fg); margin:0;
  }
  header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--line);backdrop-filter:saturate(180%) blur(8px)}
  header .inner{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;gap:8px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .spacer{flex:1}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--primary);color:#fff;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.secondary{background:#edf2f7;color:var(--fg);border:1px solid var(--line)}
  .btn.warn{background:var(--red);color:#fff}
  .btn.ghost{background:transparent;border:1px dashed var(--line);color:var(--muted)}
  .wrap{max-width:1200px;margin:22px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px;margin-bottom:16px;box-shadow:0 6px 24px rgba(15,23,42,.06)}
  h2{margin:0 0 10px 0}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{padding:6px 10px;border-radius:9999px;background:var(--pill);color:var(--fg);font-weight:600;font-size:12px;border:1px solid var(--line)}
  .muted{color:var(--muted);font-size:13px}
  input,select{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--fg)}
  input::placeholder{color:var(--muted)}
  .quick{display:grid;grid-template-columns:2.2fr 1fr 1fr 1fr 1fr auto;gap:8px}
  @media(max-width:980px){.quick{grid-template-columns:1fr 1fr 1fr 1fr 1fr auto}}
  @media(max-width:720px){.quick{grid-template-columns:1fr 1fr}}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  thead th{position:sticky;top:0;background:var(--card);z-index:1}
  tbody tr:nth-child(odd){background:color-mix(in srgb, var(--card) 96%, var(--fg) 4%)}
  .pill{display:inline-block;padding:3px 8px;border-radius:9999px;font-size:12px;font-weight:700}
  .id-pill{background:var(--pill);color:var(--fg);border:1px solid var(--line)}
  .prio-low{background:#cbd5e1;color:#0f172a}
  .prio-medium{background:#60a5fa;color:#fff}
  .prio-high{background:#f59e0b;color:#fff}
  .prio-critical{background:#ef4444;color:#fff}
  .status-not_started{background:#e2e8f0;color:#0f172a}
  .status-in_progress{background:#8b5cf6;color:#fff}
  .status-blocked{background:#111827;color:#fff}
  .status-done{background:#22c55e;color:#fff}
  .category-pill{padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
  .legend .pill.clickable{cursor:pointer;opacity:.95}
  .legend .pill.clickable.active{outline:2px solid var(--primary)}
  .no-data{color:var(--muted);padding:14px;text-align:center}
  #timeline{height:520px;border-radius:14px;border:1px solid var(--line);background:var(--card)}
  .lane-dot{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px;vertical-align:middle}
  .vis-item .vis-item-content{color:#fff;font-weight:700;padding:2px 8px;border-radius:8px}
  .vis-item.dim .vis-item-content{opacity:.18}
  .vis-selected .vis-item-content{outline:2px solid var(--primary)}
  .vis-time-axis .vis-text{color:var(--muted)}
  .vis-group{cursor:pointer}
  /* Background bands */
  .vis-item.vis-background.qbg .vis-item-content{color:var(--muted);opacity:.28;font-weight:700}
  .vis-item.vis-background.mbg-a{background:rgba(2,6,23,.03);border:none}
  .vis-item.vis-background.mbg-b{background:rgba(2,6,23,.05);border:none}
  /* Patterns for color-blind assist */
  .patterned .vis-item:not(.vis-background) .vis-item-content{background-image:var(--pattern);background-blend-mode:overlay}
  /* Dependency overlay */
  #depSvg path.conn{stroke:var(--muted);stroke-width:1.6;fill:none;stroke-dasharray:4 3}
  #depSvg path.arrow{fill:var(--muted)}
  #depSvg .dim{opacity:.18}
  /* Donut */
  #statusMini{width:140px;height:140px}
  .legend-list{display:flex;gap:12px;flex-wrap:wrap}
  .legend-item{display:flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:2px;display:inline-block}
  /* Group headers */
  .group-row{background:color-mix(in srgb, var(--card) 92%, var(--fg) 8%);font-weight:800}
  .group-toggle{cursor:pointer;color:var(--fg);margin-right:6px}
  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:var(--card);color:var(--fg);border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.16);padding:10px 12px;border-radius:12px;z-index:50}
  /* Modals */
  .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.35);backdrop-filter:blur(2px);z-index:40}
  .modal{width:min(860px,calc(100vw - 24px));}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .g12{grid-column:span 12}.g6{grid-column:span 6}.g4{grid-column:span 4}
  .quill{height:120px}
  /* Compact utility */
  .hide{display:none !important}
</style>
</head>
<body>
<a class="visually-hidden" href="#main">Skip to content</a>

<header>
  <div class="inner">
    <div class="brand">Focus.One <span class="muted">Lite</span></div>
    <div class="spacer"></div>

    <button id="tourBtn" class="btn secondary" title="Quick tour (Shift+?)">Tour</button>
    <button id="themeBtn" class="btn secondary" title="Toggle light/dark (Shift+D)">Theme</button>
    <button id="syncBtn" class="btn secondary" title="Sign in / Sync">Sign in</button>

    <a class="btn secondary" href="dashboard.html" title="Full Dashboard">Dashboard</a>
    <a class="btn secondary" href="review.html" title="Quarterly Review">Quarterly Review</a>

    <button id="exportBtn" class="btn secondary" title="Export JSON/CSV">Export</button>
    <button id="importBtn" class="btn secondary" title="Import JSON">Import</button>
    <button id="settingsBtn" class="btn secondary" title="Settings">Settings</button>
    <button id="addBtn" class="btn" title="Add goal (N)">Add Goal</button>
  </div>
</header>

<div class="wrap" id="main">

  <!-- TIMELINE -->
  <div id="timelineCard" class="card" data-intro="Your roadmap. Zoom with Ctrl + wheel, drag items to reschedule, click to focus a chain.">
    <div class="toolbar" style="justify-content:space-between;">
      <h2>Timeline</h2>
      <div class="toolbar">
        <label class="muted">Group:</label>
        <select id="groupMode" class="btn secondary" aria-label="Group timeline">
          <option value="category" selected>Category</option>
          <option value="status">Status</option>
          <option value="priority">Priority</option>
          <option value="tag">Tag</option>
          <option value="year">Year</option>
          <option value="none">None</option>
        </select>

        <button class="btn secondary" data-view="Week" title="From today + 1 week">Week</button>
        <button class="btn secondary" data-view="1M" title="From today + 1 month">1M</button>
        <button class="btn secondary" data-view="6M" title="From today + 6 months">6M</button>
        <button class="btn secondary" data-view="YTD" title="Year to date">YTD</button>
        <button class="btn secondary" data-view="5Y" title="Next 5 years">5Y</button>
        <button class="btn secondary" data-view="All" title="All goals">All</button>
        <button id="fitBtn" class="btn secondary" title="Optimal zoom to see all">Fit</button>

        <label class="muted">Zoom</label>
        <input id="zoomSlider" type="range" min="0" max="100" value="50" title="Zoom slider (hold Ctrl to wheel-zoom)">
      </div>
    </div>

    <div id="timeline"></div>

    <div class="toolbar" style="justify-content:space-between;margin-top:8px;">
      <div class="legend" id="prioLegend">
        <span class="pill prio-low clickable" data-prio="low" title="Filter low">low</span>
        <span class="pill prio-medium clickable" data-prio="medium" title="Filter medium">medium</span>
        <span class="pill prio-high clickable" data-prio="high" title="Filter high">high</span>
        <span class="pill prio-critical clickable" data-prio="critical" title="Filter critical">critical</span>
        <label class="chip"><input id="hideDone" type="checkbox"> hide done</label>
        <label class="chip"><input id="cbPatterns" type="checkbox"> color-blind patterns</label>
        <span id="itemCount" class="muted" style="margin-left:8px"></span>
      </div>
      <div class="toolbar">
        <label class="muted">Range:</label><input id="rangeStart" class="chip" placeholder="Start date">
        <input id="rangeEnd" class="chip" placeholder="End date">
        <button id="rangeSet" class="btn secondary">Apply</button>
      </div>
    </div>
  </div>

  <!-- STATUS -->
  <div class="card" data-intro="At a glance. Click a segment to filter below.">
    <div class="toolbar" style="justify-content:space-between;">
      <h2>Status</h2>
      <div class="toolbar" style="gap:16px;align-items:center">
        <canvas id="statusMini" width="140" height="140" aria-label="Status donut"></canvas>
        <div id="statusLegend" class="legend-list" role="list"></div>
      </div>
    </div>
  </div>

  <!-- GOALS -->
  <div class="card" data-intro="Fast table with inline edits, tags, notes, bulk actions.">
    <div class="toolbar" style="justify-content:space-between;align-items:end;">
      <h2>Goals</h2>
      <div class="toolbar">
        <input id="search" placeholder="Search title, category or tag ( / )" style="min-width:260px" aria-label="search goals">
        <select id="fStatus" class="btn secondary" aria-label="filter status">
          <option value="">All statuses</option>
          <option value="not_started">Not started</option>
          <option value="in_progress">In progress</option>
          <option value="blocked">Blocked</option>
          <option value="paused">Paused</option>
          <option value="planning">Planning</option>
          <option value="done">Done</option>
        </select>
        <select id="fPrio" class="btn secondary" aria-label="filter priority">
          <option value="">All priorities</option>
          <option value="low">Low</option><option value="medium">Medium</option>
          <option value="high">High</option><option value="critical">Critical</option>
        </select>
        <div id="yearBtns" class="toolbar"></div>
        <select id="tableGroup" class="btn secondary" aria-label="group table">
          <option value="category" selected>Group: Category</option>
          <option value="status">Group: Status</option>
          <option value="priority">Group: Priority</option>
          <option value="none">Group: None</option>
        </select>
        <button id="clearBtn" class="btn secondary">Clear</button>
      </div>
    </div>

    <!-- Bulk actions -->
    <div class="toolbar" id="bulkBar" style="display:none;margin:10px 0;">
      <span class="chip" id="bulkCount">0 selected</span>
      <select id="bulkAction" class="btn secondary">
        <option value="">Bulk action…</option>
        <option value="status:done">Mark done</option>
        <option value="status:in_progress">Mark in progress</option>
        <option value="status:blocked">Mark blocked</option>
        <option value="priority:low">Priority → Low</option>
        <option value="priority:medium">Priority → Medium</option>
        <option value="priority:high">Priority → High</option>
        <option value="priority:critical">Priority → Critical</option>
        <option value="delete">Delete</option>
      </select>
      <button id="bulkApply" class="btn">Apply</button>
    </div>

    <!-- Quick Add -->
    <div class="quick" style="margin:12px 0 8px;">
      <input id="qaTitle" placeholder="Quick add: goal title" aria-label="quick title">
      <input id="qaStart" type="text" placeholder="Start" aria-label="quick start">
      <input id="qaDue" type="text" placeholder="Due" aria-label="quick due">
      <select id="qaPrio" aria-label="quick priority"><option>low</option><option selected>medium</option><option>high</option><option>critical</option></select>
      <select id="qaCat" aria-label="quick category"></select>
      <button id="qaAdd" class="btn">Add</button>
    </div>

    <table aria-label="Goals table">
      <thead>
        <tr>
          <th><input id="chkAll" type="checkbox" aria-label="select all"></th>
          <th style="width:70px">ID</th><th>Title</th><th>Depends</th>
          <th>Category</th><th>Start</th><th>Due</th><th>Priority</th><th>Status</th><th>Tags</th>
          <th style="width:140px"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="muted" style="text-align:center;padding:18px" id="storageInfo">
    Data stored locally in your browser.
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="goalModal" class="backdrop" role="dialog" aria-modal="true" aria-label="Goal editor">
  <div class="card modal">
    <div class="toolbar" style="justify-content:space-between;">
      <h2 id="modalTitle">Add Goal</h2>
      <button id="closeModal" class="btn secondary">Close</button>
    </div>

    <div class="grid">
      <div class="g12">
        <label>Title</label>
        <input id="mTitle" autocomplete="off">
        <div id="eTitle" class="muted"></div>
      </div>

      <div class="g6">
        <label>Start date</label>
        <input id="mStart" type="text" placeholder="Start">
        <div id="eStart" class="muted"></div>
      </div>
      <div class="g6">
        <label>Due date</label>
        <input id="mDue" type="text" placeholder="Due">
        <div id="eDue" class="muted"></div>
      </div>

      <div class="g6">
        <label>Category</label>
        <select id="mCat"></select>
      </div>
      <div class="g6">
        <label>Status</label>
        <select id="mStatus">
          <option>planning</option>
          <option>not_started</option>
          <option>in_progress</option>
          <option>paused</option>
          <option>blocked</option>
          <option>done</option>
        </select>
      </div>

      <div class="g6">
        <label>Priority</label>
        <select id="mPrio"><option>low</option><option selected>medium</option><option>high</option><option>critical</option></select>
      </div>
      <div class="g6">
        <label>Depends on</label>
        <select id="mDep"><option value="">None</option></select>
      </div>

      <div class="g12">
        <label>Tags (comma separated)</label>
        <input id="mTags" placeholder="e.g., german, fitness">
      </div>

      <div class="g12">
        <label>Notes</label>
        <div id="mNotes" class="quill"></div>
      </div>

      <div class="g6">
        <label>Recurrence</label>
        <select id="mRecur">
          <option value="">None</option>
          <option value="W1">Weekly</option>
          <option value="M1">Monthly</option>
          <option value="Q1">Quarterly</option>
          <option value="Y1">Yearly</option>
        </select>
      </div>
      <div class="g6">
        <label>Shift dependents if I move</label>
        <select id="mShift"><option value="no" selected>No</option><option value="yes">Yes, shift chain</option></select>
      </div>

      <div class="g12">
        <label>Attachments (URLs)</label>
        <input id="mLinks" placeholder="https://… , https://…">
      </div>
    </div>

    <div class="toolbar" style="justify-content:flex-end;margin-top:10px">
      <button id="saveGoal" class="btn" disabled>Save</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="backdrop" aria-modal="true" role="dialog" aria-label="Settings">
  <div class="card modal">
    <div class="toolbar" style="justify-content:space-between;">
      <h2>Settings</h2>
      <button id="closeSettings" class="btn secondary">Close</button>
    </div>

    <div class="grid">
      <div class="g12"><h3>Localization</h3></div>
      <div class="g4">
        <label>Date format</label>
        <select id="sDateFmt">
          <option value="auto" selected>Auto (locale)</option>
          <option value="Y-m-d">YYYY-MM-DD</option>
          <option value="d/m/Y">DD/MM/YYYY</option>
          <option value="m/d/Y">MM/DD/YYYY</option>
        </select>
      </div>
      <div class="g4">
        <label>First day of week</label>
        <select id="sDow">
          <option value="1" selected>Monday</option>
          <option value="0">Sunday</option>
        </select>
      </div>
      <div class="g4">
        <label>Theme</label>
        <select id="sTheme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="auto" selected>Auto</option>
        </select>
      </div>

      <div class="g12"><h3>Categories</h3></div>
      <div class="g12" id="catTable"></div>
      <div class="g12"><button id="addCat" class="btn ghost">+ Add category</button></div>

      <div class="g12"><h3>Statuses</h3></div>
      <div class="g12" id="statusTable"></div>
      <div class="g12"><button id="addStatus" class="btn ghost">+ Add status</button></div>
    </div>
  </div>
</div>

<div id="toast" class="toast hide" role="status" aria-live="polite"></div>

<script type="module">
/* ===================== Utilities & Storage Abstraction ===================== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const once=(el,ev,fn)=>{const h=(...a)=>{el.removeEventListener(ev,h);fn(...a)}; el.addEventListener(ev,h);};
const pad=n=>String(n).padStart(2,'0');
const iso=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const toISO=x=>{const d=new Date(x); return iso(d);}
const idFmt=i=>'G'+String(i).padStart(2,'0');
const showToast=(msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.remove('hide'); setTimeout(()=>t.classList.add('hide'), 2200); }
const storeKeys={ goals:'focusone_goals', cats:'focusone_categories', statuses:'focusone_statuses', ui:'focusone_ui' };

const FB=window.__FB__ || {enabled:false};
let auth=null, db=null, user=null;

// Storage driver: local by default; Firestore if enabled + signed in
const driver={
  async init(){
    if(FB.enabled){
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
      const { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js');
      const { getFirestore, doc, getDoc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');
      const app=initializeApp(FB.config); auth=getAuth(app); db=getFirestore(app);
      driver._fs={doc,setDoc,getDoc};
      driver._auth={onAuthStateChanged,GoogleAuthProvider,signInWithPopup,signOut};
      driver._setAuthHandlers();
    }
  },
  _setAuthHandlers(){
    driver._auth.onAuthStateChanged(auth, async(u)=>{
      user=u || null;
      $('#syncBtn').textContent = user? 'Sign out' : 'Sign in';
      $('#storageInfo').textContent = user? 'Synced securely to your account.' : 'Data stored locally in your browser.';
      if(user && FB.enabled){
        // Pull cloud doc; if empty, push local
        const ref=driver._fs.doc(db,'focusone',user.uid);
        const snap=await driver._fs.getDoc(ref);
        if(snap.exists()){
          const d=snap.data();
          if(d.goals) localStorage.setItem(storeKeys.goals, JSON.stringify(d.goals));
          if(d.cats) localStorage.setItem(storeKeys.cats, JSON.stringify(d.cats));
          if(d.statuses) localStorage.setItem(storeKeys.statuses, JSON.stringify(d.statuses));
        }else{
          await driver._fs.setDoc(ref, {goals:loadGoals(), cats:loadCats(), statuses:loadStatuses()});
        }
        refresh();
      } else {
        refresh();
      }
    });
  },
  async sign(){ if(!FB.enabled){ showToast('Cloud sync not configured'); return; }
    if(user){ await driver._auth.signOut(auth); return; }
    const prov=new driver._auth.GoogleAuthProvider(); await driver._auth.signInWithPopup(auth,prov);
  },
  async push(){ if(!user || !FB.enabled) return;
    const ref=driver._fs.doc(db,'focusone',user.uid);
    await driver._fs.setDoc(ref,{goals:loadGoals(),cats:loadCats(),statuses:loadStatuses()},{merge:true});
    showToast('Synced to cloud ✓');
  }
};
$('#syncBtn').onclick=()=>driver.sign();

/* Local storage helpers (fallback always exists) */
const load = (k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

function loadGoals(){ return load(storeKeys.goals, []); }
function setGoals(v){ save(storeKeys.goals, v); driver.push(); }
function loadCats(){ return load(storeKeys.cats, []); }
function setCats(v){ save(storeKeys.cats, v); driver.push(); }
function loadStatuses(){ return load(storeKeys.statuses, [
  {id:'planning', name:'planning', color:'#64748b'},
  {id:'not_started', name:'not_started', color:'#e2e8f0'},
  {id:'in_progress', name:'in_progress', color:'#8b5cf6'},
  {id:'paused', name:'paused', color:'#94a3b8'},
  {id:'blocked', name:'blocked', color:'#0f172a'},
  {id:'done', name:'done', color:'#22c55e'}
]);}
function setStatuses(v){ save(storeKeys.statuses, v); driver.push(); }

function loadUI(){ return load(storeKeys.ui, {dateFmt:'auto', dow:1, theme:'auto', filters:{}}); }
function setUI(v){ save(storeKeys.ui, v); }

/* Seeds if empty */
(function seed(){
  if(loadCats().length===0){
    setCats([
      {id:crypto.randomUUID(), name:'Language', color:'#2563eb'},
      {id:crypto.randomUUID(), name:'Career', color:'#16a34a'},
      {id:crypto.randomUUID(), name:'Health', color:'#ef4444'},
      {id:crypto.randomUUID(), name:'Business', color:'#0d9488'},
      {id:crypto.randomUUID(), name:'Other', color:'#6b7280'}
    ]);
  }
  if(loadGoals().length===0){
    const s=new Date(), d=new Date(); d.setDate(s.getDate()+45);
    const c=loadCats()[0].id;
    setGoals([{id:crypto.randomUUID(), title:'Example: German A2', start_date:iso(s), due_date:iso(d), priority:'medium', status:'in_progress', categoryId:c, tags:['language'], notes:'', recur:'', links:[], dependsOnId:null }]);
  }
})();

/* ===================== UI State & Globals ===================== */
let VIEW='6M', GROUP='category', PRIO='', TBL_GROUP='category', YEAR='', HIDE_DONE=false, PATTERNED=false;
let RANGE=null;                 // {start,end} custom range
let FOCUS=new Set();            // focused dependency chain
let COLLAPSED=new Set();        // collapsed groups in timeline
let timeline, itemsDS, groupsDS, depSvg, quill, qaStart, qaDue, mStart, mDue, rStart, rEnd;

const idMap=()=> new Map(loadGoals().map((g,i)=>[g.id, idFmt(i+1)]));

/* ===================== Theme & Localization ===================== */
function applyTheme(){
  const pref=loadUI().theme||'auto';
  const root=document.documentElement;
  const sys=window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
  const theme = pref==='auto'? sys : pref;
  root.setAttribute('data-theme', theme);
}
$('#themeBtn').onclick=()=>{ const ui=loadUI(); ui.theme = ui.theme==='dark'?'light' : ui.theme==='light'?'auto':'dark'; setUI(ui); applyTheme(); showToast(`Theme: ${ui.theme}`); };
document.addEventListener('keydown',e=>{if(e.shiftKey && (e.key==='D'||e.key==='d')) $('#themeBtn').click();});

/* Flatpickr helpers based on settings */
function fpOpts(){ const ui=loadUI(); const dateFmt = ui.dateFmt==='auto' ? undefined : ui.dateFmt;
  return { dateFormat: dateFmt || 'Y-m-d', weekNumbers:true, allowInput:true, clickOpens:true, locale: ui.dow==0?'en': 'en', firstDayOfWeek: Number(ui.dow) };
}

/* ===================== Onboarding ===================== */
$('#tourBtn').onclick=()=> introJs().setOptions({
  nextLabel:'Next', prevLabel:'Back', doneLabel:'Done', showProgress:true, disableInteraction:false,
}).start();
document.addEventListener('keydown',e=>{ if(e.shiftKey && e.key==='?') $('#tourBtn').click(); });

/* ===================== Export / Import ===================== */
$('#exportBtn').onclick=()=>{
  const data={goals:loadGoals(),categories:loadCats(),statuses:loadStatuses()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='focusone-data.json'; a.click(); URL.revokeObjectURL(url);
  showToast('Exported JSON: focusone-data.json');
};
$('#importBtn').onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='application/json';
  i.onchange=()=>{ const f=i.files[0]; if(!f) return; const fr=new FileReader();
    fr.onload=()=>{ try{ const d=JSON.parse(fr.result);
      if(Array.isArray(d.goals)&&Array.isArray(d.categories)){ setCats(d.categories); setGoals(d.goals); if(d.statuses) setStatuses(d.statuses); refresh(); showToast('Imported ✓'); }
      else alert('Invalid JSON');
    }catch{ alert('Invalid JSON'); } };
    fr.readAsText(f);
  }; i.click();
};

/* ===================== Settings (categories/statuses/localization) ===================== */
const setModal=$('#settingsModal');
function openSettings(){
  setModal.style.display='flex';
  // Localization
  const ui=loadUI(); $('#sDateFmt').value=ui.dateFmt||'auto'; $('#sDow').value=ui.dow??1; $('#sTheme').value=ui.theme||'auto';
  // Categories table
  renderCatTable(); renderStatusTable();
}
$('#settingsBtn').onclick=openSettings; $('#closeSettings').onclick=()=>setModal.style.display='none';
$('#sDateFmt').onchange=()=>{ const ui=loadUI(); ui.dateFmt=$('#sDateFmt').value; setUI(ui); buildPickers(); refreshTimeline(); };
$('#sDow').onchange=()=>{ const ui=loadUI(); ui.dow=$('#sDow').value; setUI(ui); buildPickers(); refreshTimeline(); };
$('#sTheme').onchange=()=>{ const ui=loadUI(); ui.theme=$('#sTheme').value; setUI(ui); applyTheme(); };

function renderCatTable(){
  const wrap=$('#catTable'); const cats=loadCats();
  wrap.innerHTML = `<table><thead><tr><th>Name</th><th>Color</th><th></th></tr></thead><tbody>${cats.map((c,i)=>`
    <tr>
      <td><input data-cname="${c.id}" value="${c.name}"></td>
      <td><input type="color" data-ccolor="${c.id}" value="${c.color}"></td>
      <td class="toolbar">
        <button class="btn secondary" data-cup="${c.id}">↑</button>
        <button class="btn secondary" data-cdown="${c.id}">↓</button>
        <button class="btn warn" data-cdel="${c.id}">Delete</button>
      </td>
    </tr>`).join('')}</tbody></table>`;
  wrap.querySelectorAll('[data-cname]').forEach(i=> i.oninput=()=>{ const cats=loadCats(); const c=cats.find(x=>x.id===i.dataset.cname); c.name=i.value; setCats(cats); rebuildTimeline(); renderTable(); });
  wrap.querySelectorAll('[data-ccolor]').forEach(i=> i.oninput=()=>{ const cats=loadCats(); const c=cats.find(x=>x.id===i.dataset.ccolor); c.color=i.value; setCats(cats); rebuildTimeline(); renderTable(); });
  wrap.querySelectorAll('[data-cdel]').forEach(b=> b.onclick=()=>{ const cats=loadCats().filter(x=>x.id!==b.dataset.cdel); setCats(cats); renderCatTable(); rebuildTimeline(); renderTable(); });
  wrap.querySelectorAll('[data-cup]').forEach(b=> b.onclick=()=>{ const cats=loadCats(); const i=cats.findIndex(x=>x.id===b.dataset.cup); if(i>0){ [cats[i-1],cats[i]]=[cats[i],cats[i-1]]; setCats(cats); renderCatTable(); rebuildTimeline(); }});
  wrap.querySelectorAll('[data-cdown]').forEach(b=> b.onclick=()=>{ const cats=loadCats(); const i=cats.findIndex(x=>x.id===b.dataset.cdown); if(i<cats.length-1){ [cats[i+1],cats[i]]=[cats[i],cats[i+1]]; setCats(cats); renderCatTable(); rebuildTimeline(); }});
}
$('#addCat').onclick=()=>{ const cats=loadCats(); cats.push({id:crypto.randomUUID(), name:'New Category', color:'#3b82f6'}); setCats(cats); renderCatTable(); rebuildTimeline(); renderTable(); };

function renderStatusTable(){
  const wrap=$('#statusTable'); const sts=loadStatuses();
  wrap.innerHTML=`<table><thead><tr><th>Name</th><th>Color</th><th></th></tr></thead><tbody>${sts.map((s,i)=>`
    <tr>
      <td><input data-sname="${s.id}" value="${s.name}"></td>
      <td><input type="color" data-scolor="${s.id}" value="${s.color}"></td>
      <td class="toolbar">
        <button class="btn secondary" data-sup="${s.id}">↑</button>
        <button class="btn secondary" data-sdown="${s.id}">↓</button>
        <button class="btn warn" data-sdel="${s.id}">Delete</button>
      </td>
    </tr>`).join('')}</tbody></table>`;
  wrap.querySelectorAll('[data-sname]').forEach(i=> i.oninput=()=>{ const v=loadStatuses(); const s=v.find(x=>x.id===i.dataset.sname); s.name=i.value; setStatuses(v); renderTable(); rebuildTimeline(); });
  wrap.querySelectorAll('[data-scolor]').forEach(i=> i.oninput=()=>{ const v=loadStatuses(); const s=v.find(x=>x.id===i.dataset.scolor); s.color=i.value; setStatuses(v); renderTable(); rebuildTimeline(); });
  wrap.querySelectorAll('[data-sdel]').forEach(b=> b.onclick=()=>{ const v=loadStatuses().filter(x=>x.id!==b.dataset.sdel); setStatuses(v); renderStatusTable(); renderTable(); rebuildTimeline(); });
  wrap.querySelectorAll('[data-sup]').forEach(b=> b.onclick=()=>{ const v=loadStatuses(); const i=v.findIndex(x=>x.id===b.dataset.sup); if(i>0){ [v[i-1],v[i]]=[v[i],v[i-1]]; setStatuses(v); renderStatusTable(); rebuildTimeline(); }});
  wrap.querySelectorAll('[data-sdown]').forEach(b=> b.onclick=()=>{ const v=loadStatuses(); const i=v.findIndex(x=>x.id===b.dataset.sdown); if(i<v.length-1){ [v[i+1],v[i]]=[v[i],v[i+1]]; setStatuses(v); renderStatusTable(); rebuildTimeline(); }});
}
$('#addStatus').onclick=()=>{ const v=loadStatuses(); v.push({id:crypto.randomUUID(), name:'new_status', color:'#64748b'}); setStatuses(v); renderStatusTable(); renderTable(); rebuildTimeline(); };

/* ===================== Goal Modal (add/edit) ===================== */
const modal=$('#goalModal');
let editing=null;
function openModal(g={}){
  editing=g.id||null; $('#modalTitle').textContent=editing?'Edit Goal':'Add Goal';
  // categories
  $('#mCat').innerHTML=loadCats().map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  $('#mStatus').innerHTML=loadStatuses().map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  // depends (list current)
  $('#mDep').innerHTML = `<option value="">None</option>` + loadGoals().map(x=>`<option value="${x.id}">${x.title}</option>`).join('');
  // values
  $('#mTitle').value=g.title||''; quill.setContents(quill.clipboard.convert(g.notes||'')); 
  $('#mStart')._fp.setDate(g.start_date||null); $('#mDue')._fp.setDate(g.due_date||null);
  $('#mCat').value=g.categoryId||$('#mCat').value;
  $('#mStatus').value=g.status||'not_started';
  $('#mPrio').value=g.priority||'medium';
  $('#mDep').value=g.dependsOnId||'';
  $('#mTags').value=(g.tags||[]).join(', ');
  $('#mLinks').value=(g.links||[]).join(', ');
  $('#mRecur').value=g.recur||'';
  $('#mShift').value='no';
  $('#saveGoal').disabled=true;
  modal.style.display='flex';
  $('#mTitle').focus();
}
function closeGoal(){ modal.style.display='none'; editing=null; }
$('#addBtn').onclick=()=>openModal();
$('#closeModal').onclick=closeGoal;
['#mTitle','#mStart','#mDue','#mCat','#mStatus','#mPrio','#mDep','#mTags','#mRecur'].forEach(sel=>{
  $(sel).addEventListener('input',validateGoal);
  $(sel).addEventListener('change',validateGoal);
});
function validateGoal(){
  const title=$('#mTitle').value.trim();
  const s=$('#mStart').value, d=$('#mDue').value;
  let ok=!!title && !!s && !!d && s<=d;
  $('#eTitle').textContent=title?'':'Title required'; 
  $('#eStart').textContent=s?'':'Start required';
  $('#eDue').textContent= d ? (s>d?'Due must be after start':'') : 'Due required';
  $('#saveGoal').disabled=!ok;
}
$('#saveGoal').onclick=()=>{
  const d={
    title:$('#mTitle').value.trim(),
    start_date: $('#mStart').value, due_date: $('#mDue').value,
    categoryId: $('#mCat').value, status: $('#mStatus').value, priority: $('#mPrio').value,
    dependsOnId: $('#mDep').value || null,
    tags: $('#mTags').value.split(',').map(s=>s.trim()).filter(Boolean),
    notes: quill.root.innerHTML.trim(),
    links: $('#mLinks').value.split(',').map(s=>s.trim()).filter(Boolean),
    recur: $('#mRecur').value
  };
  let list=loadGoals();
  if(editing){ list = list.map(x=>x.id===editing? {...x,...d}:x); }
  else { list = [...list, {id:crypto.randomUUID(), ...d}]; }
  setGoals(list); refresh(); closeGoal();
};

/* ===================== Year Buttons & Filters ===================== */
let YEAR_BTNS=$('#yearBtns');
function buildYears(){
  YEAR_BTNS.innerHTML='';
  const years=[...new Set(loadGoals().flatMap(g=>[g.start_date?.slice(0,4),g.due_date?.slice(0,4)]) )].filter(Boolean).sort();
  const mk=(label,val)=>{ const b=document.createElement('button'); b.className='btn secondary'; b.textContent=label; if(val===YEAR) b.classList.add('active');
    b.onclick=()=>{ YEAR=(YEAR===val)?'':val; buildYears(); renderTable(); refreshTimeline(); }; return b; };
  YEAR_BTNS.appendChild(mk('All','')); YEAR_BTNS.appendChild(mk('YTD','YTD')); years.forEach(y=>YEAR_BTNS.appendChild(mk(y,y)));
}
$('#clearBtn').onclick=()=>{ $('#search').value=''; $('#fStatus').value=''; $('#fPrio').value=''; PRIO=''; YEAR=''; HIDE_DONE=false; $('#hideDone').checked=false; FOCUS.clear(); COLLAPSED.clear(); syncPrioLegend(); buildYears(); renderTable(); refreshTimeline(); renderStatus(); };

/* ===================== Status (donut, clickable) ===================== */
function renderStatus(){
  const L=loadGoals();
  const by=(id)=>L.filter(g=>g.status===id).length;
  const statuses=loadStatuses();
  const vals=statuses.map(s=>by(s.id)), cols=statuses.map(s=>s.color), labs=statuses.map(s=>s.name);
  const total=vals.reduce((a,b)=>a+b,0)||1;
  const canvas=$('#statusMini'), ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const cx=70, cy=70, r=64, inner=40; let start=-Math.PI/2;
  vals.forEach((v,i)=>{ const a=(v/total)*2*Math.PI; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+a); ctx.closePath(); ctx.fillStyle=cols[i]; ctx.fill(); start+=a; });
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
  const doneIdx = labs.findIndex(l=>l==='done'), pct = total? Math.round((vals[doneIdx]||0)/total*100):0;
  ctx.fillStyle='var(--fg)'; ctx.font='700 18px ui-sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(pct+'%',cx,cy);
  const legend=$('#statusLegend'); legend.innerHTML='';
  labs.forEach((lab,i)=>{ const v=vals[i],p=Math.round(v/total*100);
    const div=document.createElement('button'); div.className='legend-item btn secondary'; div.style.borderColor=cols[i]; div.style.color='var(--fg)';
    div.innerHTML=`<span class="dot" style="background:${cols[i]}"></span><span>${lab}: <b>${v}</b> (${p}%)</span>`;
    div.onclick=()=>{ $('#fStatus').value = $('#fStatus').value===statuses[i].id ? '' : statuses[i].id; renderTable(); refreshTimeline(); };
    legend.appendChild(div);
  });
}

/* ===================== Table (grouped + inline edit + bulk) ===================== */
$('#search').oninput=renderTable; $('#fStatus').onchange=()=>{ renderTable(); refreshTimeline(); }; 
$('#fPrio').onchange=()=>{ PRIO=$('#fPrio').value; syncPrioLegend(); renderTable(); refreshTimeline(); };
$('#tableGroup').onchange=e=>{ TBL_GROUP=e.target.value; renderTable(); };
$('#chkAll').onchange=()=>{ $$('#rows input[type=checkbox]').forEach(cb=>{ cb.checked=$('#chkAll').checked; }); updateBulk(); };
$('#bulkApply').onclick=applyBulk;
$('#bulkAction').onchange=updateBulk;

function updateBulk(){ const ids=selectedIds(); $('#bulkCount').textContent=`${ids.length} selected`; $('#bulkBar').style.display= ids.length? 'flex':'none'; }
function selectedIds(){ return $$('#rows input[type=checkbox]:checked').map(cb=>cb.dataset.id); }
function applyBulk(){
  const ids=selectedIds(); const action=$('#bulkAction').value; if(!ids.length||!action) return;
  let list=loadGoals();
  if(action==='delete'){ if(!confirm('Delete selected goals?')) return; list=list.filter(g=>!ids.includes(g.id)); }
  else if(action.startsWith('status:')){ const val=action.split(':')[1]; list=list.map(g=> ids.includes(g.id)? {...g,status:val}:g); }
  else if(action.startsWith('priority:')){ const val=action.split(':')[1]; list=list.map(g=> ids.includes(g.id)? {...g,priority:val}:g); }
  setGoals(list); renderTable(); refreshTimeline(); showToast('Bulk action applied ✓');
}

function renderTable(){
  const q=($('#search').value||'').toLowerCase(), fs=$('#fStatus').value, fp=PRIO||$('#fPrio').value;
  const today=iso(new Date()); const yStart=iso(new Date(new Date().getFullYear(),0,1));
  let list=loadGoals().filter(g=>{
    if(q){
      const cat=loadCats().find(c=>c.id===g.categoryId)?.name||'';
      const tags=(g.tags||[]).join(' ');
      if(!g.title.toLowerCase().includes(q)&&!cat.toLowerCase().includes(q)&&!tags.toLowerCase().includes(q)) return false;
    }
    if(fs && g.status!==fs) return false;
    if(fp && g.priority!==fp) return false;
    if(YEAR==='YTD'){ if(!(g.due_date>=yStart && g.start_date<=today)) return false; }
    else if(YEAR){ const sy=g.start_date?.slice(0,4), dy=g.due_date?.slice(0,4); if(sy!==YEAR && dy!==YEAR) return false; }
    if(HIDE_DONE && g.status==='done') return false;
    if(RANGE){ if(!(new Date(g.due_date)>=RANGE.start && new Date(g.start_date)<=RANGE.end)) return false; }
    return true;
  });
  const cats=loadCats(), sts=loadStatuses(), ids=idMap(), tb=$('#rows');
  if(list.length===0){ tb.innerHTML='<tr><td colspan="11" class="no-data">No goals match your filters.</td></tr>'; return; }
  const key=g=> TBL_GROUP==='category' ? (cats.find(c=>c.id===g.categoryId)?.name||'Uncategorized')
               : TBL_GROUP==='status'   ? g.status
               : TBL_GROUP==='priority' ? g.priority
               : 'All';
  const groups={}; list.forEach(g=>{ (groups[key(g)]||(groups[key(g)]=[])).push(g); });
  const order=Object.keys(groups).sort((a,b)=> String(a).localeCompare(String(b)));
  const row=g=>{
    const cat=cats.find(c=>c.id===g.categoryId)||{name:'Other',color:'#6b7280'};
    const dep=g.dependsOnId? ids.get(g.dependsOnId):'';
    const tagHtml=(g.tags||[]).map(t=>`<span class="chip">${t}</span>`).join(' ');
    return `<tr data-id="${g.id}">
      <td><input type="checkbox" data-id="${g.id}"></td>
      <td><span class="pill id-pill">${ids.get(g.id)}</span></td>
      <td data-field="title" title="Click to edit">${esc(g.title)} ${dep?`<span class="chip">↳ ${dep}</span>`:''}</td>
      <td>${dep?`<span class="chip">${dep}</span>`:''}</td>
      <td data-field="categoryId"><span class="category-pill" style="background:${cat.color}">${esc(cat.name)}</span></td>
      <td data-field="start_date">${g.start_date||''}</td>
      <td data-field="due_date">${g.due_date||''}</td>
      <td data-field="priority"><span class="pill prio-${g.priority}">${g.priority}</span></td>
      <td data-field="status"><span class="pill status-${g.status}">${g.status.replace('_',' ')}</span></td>
      <td data-field="tags">${tagHtml}</td>
      <td class="toolbar" style="gap:6px;">
        <button class="btn secondary" data-edit="${g.id}">Edit</button>
        <button class="btn warn" data-del="${g.id}">Delete</button>
      </td>
    </tr>`;
  };
  let html=''; order.forEach(name=>{ html+=`<tr class="group-row"><td colspan="11"><span class="group-toggle">▾</span>${esc(name)} <span class="muted">(${groups[name].length})</span></td></tr>`; groups[name].forEach(g=>html+=row(g)); });
  tb.innerHTML=html;
  tb.querySelectorAll('.group-toggle').forEach(tg=>{
    tg.onclick=()=>{ const open=tg.textContent.trim().startsWith('▾'); tg.textContent=open?'▸':'▾';
      let el=tg.closest('tr').nextElementSibling; while(el && !el.classList.contains('group-row')){ el.style.display=open?'none':'table-row'; el=el.nextElementSibling; } };
  });
  tb.querySelectorAll('td[data-field]').forEach(td=> td.onclick=()=>inlineEdit(td));
  tb.querySelectorAll('[data-edit]').forEach(b=>b.onclick=e=>{ e.stopPropagation(); const g=loadGoals().find(x=>x.id===b.dataset.edit); if(g) openModal(g); });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=e=>{ e.stopPropagation(); const id=b.dataset.del; if(confirm('Delete this goal?')){ setGoals(loadGoals().filter(x=>x.id!==id)); refresh(); } });
  tb.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.onchange=updateBulk);
}

/* Inline edit */
function inlineEdit(td){
  const tr=td.closest('tr'); const id=tr.dataset.id; const list=loadGoals(); const g=list.find(x=>x.id===id); if(!g) return;
  const field=td.dataset.field; const commit=v=>{ const u={...g,[field]:v}; if(u.start_date && u.due_date && u.start_date>u.due_date){ alert('Start after Due'); renderTable(); return; } setGoals(list.map(x=>x.id===id?u:x)); refreshTimeline(); renderTable(); };
  let ed;
  if(field==='title'){ ed=document.createElement('input'); ed.value=g.title; ed.onkeydown=e=>{if(e.key==='Enter')commit(ed.value.trim()); if(e.key==='Escape')renderTable()}; ed.onblur=()=>commit(ed.value.trim()); }
  else if(field==='start_date'||field==='due_date'){ ed=document.createElement('input'); ed.type='text'; ed.value=g[field]||''; flatpickr(ed,{...fpOpts(), defaultDate:g[field]||null, onClose:()=>commit(ed.value)}); }
  else if(field==='priority'){ ed=document.createElement('select'); ['low','medium','high','critical'].forEach(p=>ed.appendChild(new Option(p,p,p===g.priority,p===g.priority))); ed.onchange=()=>commit(ed.value); }
  else if(field==='status'){ ed=document.createElement('select'); loadStatuses().forEach(s=>ed.appendChild(new Option(s.name,s.id,s.id===g.status,s.id===g.status))); ed.onchange=()=>commit(ed.value); }
  else if(field==='categoryId'){ ed=document.createElement('select'); loadCats().forEach(c=>ed.appendChild(new Option(c.name,c.id,c.id===g.categoryId,c.id===g.categoryId))); ed.onchange=()=>commit(ed.value); }
  else if(field==='tags'){ ed=document.createElement('input'); ed.value=(g.tags||[]).join(', '); ed.onkeydown=e=>{if(e.key==='Enter')commit(ed.value.split(',').map(s=>s.trim()).filter(Boolean)); if(e.key==='Escape')renderTable()}; ed.onblur=()=>commit(ed.value.split(',').map(s=>s.trim()).filter(Boolean)); }
  td.innerHTML=''; td.appendChild(ed); ed.focus(); if(ed.select) ed.select();
}

/* ===================== Timeline (vis) ===================== */
let depTimer;
function rangeFor(view){
  const t=new Date(), y=t.getFullYear();
  switch(view){
    case 'Week': return {start:t, end:new Date(t.getFullYear(), t.getMonth(), t.getDate()+7)};
    case '1M':   return {start:t, end:new Date(t.getFullYear(), t.getMonth()+1, t.getDate())};
    case '6M':   return {start:t, end:new Date(t.getFullYear(), t.getMonth()+6, t.getDate())};
    case 'YTD':  return {start:t, end:new Date(y,11,31)};
    case '5Y':   return {start:t, end:new Date(y+5, t.getMonth(), t.getDate())};
    default:     return null;
  }
}
function setView(v){ VIEW=v; $$('#timelineCard [data-view]').forEach(b=>b.classList.toggle('active', b.dataset.view===v)); refreshTimeline(); }
$$('#timelineCard [data-view]').forEach(b=>b.onclick=()=>setView(b.dataset.view));
$('#fitBtn').onclick=()=>{ VIEW='All'; refreshTimeline(true); };
$('#groupMode').onchange=e=>{ GROUP=e.target.value; COLLAPSED.clear(); refreshTimeline(); };
$('#hideDone').onchange=()=>{ HIDE_DONE=$('#hideDone').checked; renderTable(); refreshTimeline(); };
$('#cbPatterns').onchange=()=>{ PATTERNED=$('#cbPatterns').checked; $('#timeline').classList.toggle('patterned', PATTERNED); };
$('#rangeSet').onclick=()=>{ if(rStart.selectedDates[0]&&rEnd.selectedDates[0]){ RANGE={start:rStart.selectedDates[0], end:rEnd.selectedDates[0]}; refreshTimeline(); renderTable(); }};

function viewWindow(){ if(!timeline){ const r=rangeFor(VIEW)||{start:new Date(), end:new Date(new Date().getFullYear(), new Date().getMonth()+1, 1)}; return r; } const w=timeline.getWindow(); return {start:w.start,end:w.end}; }
function ensureDepSvg(){
  const content = timeline.dom.center.querySelector('.vis-content'); if(!content) return;
  if(!depSvg){ depSvg=document.createElementNS('http://www.w3.org/2000/svg','svg'); depSvg.id='depSvg'; depSvg.style.position='absolute'; depSvg.style.left='0'; depSvg.style.top='0'; depSvg.style.pointerEvents='none'; content.appendChild(depSvg); }
  const r=content.getBoundingClientRect(); depSvg.setAttribute('width', r.width); depSvg.setAttribute('height', r.height);
}
function drawDepsSoon(){ clearTimeout(depTimer); depTimer=setTimeout(drawDependencies, 40); }
function drawDependencies(){
  if(!timeline || !depSvg) return; const content = timeline.dom.center.querySelector('.vis-content'); const r=content.getBoundingClientRect();
  depSvg.innerHTML=''; const all=loadGoals();
  all.forEach(g=>{
    if(!g.dependsOnId) return;
    const from=content.querySelector(`.vis-item[data-id="${g.dependsOnId}"]`);
    const to=content.querySelector(`.vis-item[data-id="${g.id}"]`);
    if(!from||!to) return; const a=from.getBoundingClientRect(), b=to.getBoundingClientRect();
    const x1=a.right-r.left, y1=a.top-r.top+a.height/2, x2=b.left-r.left, y2=b.top-r.top+b.height/2, mid=(x1+x2)/2;
    const p=document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d',`M${x1} ${y1} C ${mid} ${y1} ${mid} ${y2} ${x2} ${y2}`); p.setAttribute('class','conn'); if(FOCUS.size && !(FOCUS.has(g.dependsOnId)&&FOCUS.has(g.id))) p.classList.add('dim'); depSvg.appendChild(p);
    const tri=document.createElementNS('http://www.w3.org/2000/svg','path'); tri.setAttribute('d',`M ${x2-7} ${y2-4} L ${x2} ${y2} L ${x2-7} ${y2+4} Z`); tri.setAttribute('class','arrow'); if(FOCUS.size && !(FOCUS.has(g.dependsOnId)&&FOCUS.has(g.id))) tri.classList.add('dim'); depSvg.appendChild(tri);
  });
}
function focusChain(id){
  const all=loadGoals(), byId=new Map(all.map(g=>[g.id,g])); FOCUS=new Set([id]);
  let cur=byId.get(id); while(cur && cur.dependsOnId){ FOCUS.add(cur.dependsOnId); cur=byId.get(cur.dependsOnId); }
  let expand=true; while(expand){ expand=false; for(const g of all){ if(g.dependsOnId && FOCUS.has(g.dependsOnId) && !FOCUS.has(g.id)){ FOCUS.add(g.id); expand=true; } } }
  dimItems(); drawDepsSoon();
}
function dimItems(){ $$('#timeline .vis-item').forEach(n=>{ const id=n.getAttribute('data-id'); if(FOCUS.size && !FOCUS.has(id)) n.classList.add('dim'); else n.classList.remove('dim'); }); }

/* Build timeline from data */
function refreshTimeline(forceFit=false){
  const raw=loadGoals(); const ids=idMap(); const cats=loadCats(), sts=loadStatuses();
  const statusesById=new Map(sts.map(s=>[s.id,s]));
  const today=iso(new Date()), yStart=iso(new Date(new Date().getFullYear(),0,1));
  let list=raw.filter(g=>{
    if(PRIO && g.priority!==PRIO) return false;
    if(YEAR==='YTD'){ if(!(g.due_date>=yStart && g.start_date<=today)) return false; }
    else if(YEAR){ const sy=g.start_date?.slice(0,4), dy=g.due_date?.slice(0,4); if(sy!==YEAR && dy!==YEAR) return false; }
    if(HIDE_DONE && g.status==='done') return false;
    if(RANGE){ if(!(new Date(g.due_date)>=RANGE.start && new Date(g.start_date)<=RANGE.end)) return false; }
    return true;
  });

  // group key & label/color
  const key=g=> GROUP==='category' ? (g.categoryId||'uncat')
              : GROUP==='status'   ? (g.status||'nostatus')
              : GROUP==='priority' ? (g.priority||'priority')
              : GROUP==='tag'      ? ((g.tags&&g.tags[0])||'untagged')
              : GROUP==='year'     ? (g.start_date?.slice(0,4)||'year')
              : 'all';
  const label=k=> GROUP==='category' ? (cats.find(c=>c.id===k)?.name||'Uncategorized')
               : GROUP==='status'   ? (sts.find(s=>s.id===k)?.name||k)
               : GROUP==='priority' ? k
               : GROUP==='tag'      ? k
               : GROUP==='year'     ? k
               : 'All goals';
  const color=k=> GROUP==='category' ? (cats.find(c=>c.id===k)?.color||'#6b7280')
               : GROUP==='status'   ? (statusesById.get(k)?.color||'#6b7280')
               : GROUP==='priority' ? ({low:'#94a3b8',medium:'#60a5fa',high:'#f59e0b',critical:'#ef4444'}[k]||'#3b82f6')
               : GROUP==='tag'      ? '#3b82f6'
               : GROUP==='year'     ? '#0ea5e9'
               : '#3b82f6';

  // groups order by visible count
  const lanes={}; list.forEach(g=>{ const k=key(g); (lanes[k]||(lanes[k]=[])).push(g); });
  const rng=viewWindow();
  const activeScore=k=> (lanes[k]||[]).reduce((a,g)=> a + (new Date(g.due_date)>=rng.start && new Date(g.start_date)<=rng.end ? 1 : 0), 0);
  const order=Object.keys(lanes).sort((a,b)=> activeScore(b)-activeScore(a) || label(a).localeCompare(label(b)));
  const groups = order.map(k=>({ id:k, content:`<span class="lane-dot" style="background:${color(k)}"></span>${label(k)} <span class="muted">(${lanes[k].length})</span>`, order:activeScore(k), visible:!COLLAPSED.has(k) }));

  // items (with recurrence: render shadow instances)
  const items=[];
  function pushBar(g,start,end){
    const k=key(g); if(COLLAPSED.has(k)) return;
    items.push({
      id:g.id + (start!==g.start_date? '_r'+start : ''),  // unique for recurrences
      group:k, subgroup:(g.dependsOnId||g.id),
      start, end: addDays(end,1), 
      content:`${ids.get(g.id)} · ${esc(g.title.length>28?g.title.slice(0,26)+'…':g.title)}`,
      title:`${g.title}\n${g.start_date} → ${g.due_date}\n${g.priority} • ${g.status}`,
      style:`background:${color(k)};border-color:rgba(0,0,0,.15)`,
      className:(FOCUS.size && !FOCUS.has(g.id)) ? 'dim' : '',
      dependsOnId:g.dependsOnId||null,
      _root:g.id
    });
  }
  list.forEach(g=>{
    if(!g.recur){ pushBar(g,g.start_date,g.due_date); }
    else{
      // simple instances within visible window only
      const r=viewWindow(); let s=new Date(g.start_date), e=new Date(g.due_date);
      while(e<=r.end){ // move forward until window end
        if(e>=r.start) pushBar(g, iso(s), iso(e));
        if(g.recur.startsWith('W')){ s.setDate(s.getDate()+7); e.setDate(e.getDate()+7); }
        else if(g.recur.startsWith('M')){ s.setMonth(s.getMonth()+1); e.setMonth(e.getMonth()+1); }
        else if(g.recur.startsWith('Q')){ s.setMonth(s.getMonth()+3); e.setMonth(e.getMonth()+3); }
        else if(g.recur.startsWith('Y')){ s.setFullYear(s.getFullYear()+1); e.setFullYear(e.getFullYear()+1); }
        else break;
      }
    }
  });

  // background quarter & month bands
  const backs = quarterMonthBands();

  const container=$('#timeline');
  const opts={
    orientation:'top', multiselect:false,
    editable:{updateTime:true, updateGroup:false, add:false, remove:false},
    margin:{item:10, axis:28},
    stack:true, stackSubgroups:true, subgroupStack:true,
    groupOrder:(a,b)=> (b.order||0)-(a.order||0),
    verticalScroll:true, maxHeight:'520px', minHeight:'520px',
    zoomKey:'ctrlKey', zoomMin: 1000*60*60*24*3,
    tooltip:{followMouse:true}
  };

  if(!timeline){
    itemsDS=new vis.DataSet(items.concat(backs));
    groupsDS=new vis.DataSet(groups);
    timeline=new vis.Timeline(container, itemsDS, groupsDS, opts);
    // drag/resize save + dependency alerts
    itemsDS.on('update', (evt,props)=>{
      if(!props||!props.items) return; const all=loadGoals(); let changed=false;
      props.items.forEach(id=>{
        const it=itemsDS.get(id); if(!it||!it.start||!it.end) return;
        const root=all.find(x=>x.id===it._root || x.id===id); if(!root) return;
        const prevS=root.start_date, prevE=root.due_date;
        const s=toISO(it.start), e=toISO(new Date(it.end.getTime()-86400000));
        if(prevS!==s || prevE!==e){
          root.start_date=s; root.due_date=e; changed=true;
          // dependency guard: if prerequisite ends after dependent starts
          const affected=all.filter(g=>g.dependsOnId===root.id);
          affected.forEach(dep=>{
            if(new Date(root.due_date) > new Date(dep.start_date)){
              if(confirm(`"${root.title}" now ends after "${dep.title}" starts. Shift dependent to maintain gap?`)){
                const shift = (new Date(root.due_date) - new Date(dep.start_date))/86400000 + 1;
                const ns=new Date(dep.start_date); ns.setDate(ns.getDate()+shift);
                const ne=new Date(dep.due_date); ne.setDate(ne.getDate()+shift);
                dep.start_date=iso(ns); dep.due_date=iso(ne);
              }
            }
          });
        }
      });
      if(changed){ setGoals(all); renderTable(); renderStatus(); refreshTimeline(); }
    });
    // focus chain
    timeline.on('select',p=>{ if(p.items.length){ const node=itemsDS.get(p.items[0]); focusChain(node._root); } else {FOCUS.clear(); dimItems(); drawDepsSoon();} });
    // collapse group on click label
    timeline.on('click',p=>{
      if(p.what==='group-label' && p.group){ if(COLLAPSED.has(p.group)) COLLAPSED.delete(p.group); else COLLAPSED.add(p.group); refreshTimeline(); }
    });
    // redraw deps when view moves
    const upd=()=>drawDepsSoon(); timeline.on('changed',upd); timeline.on('rangechanged',upd); window.addEventListener('resize',upd);
  } else {
    itemsDS.clear(); itemsDS.add(items.concat(backs));
    groupsDS.clear(); groupsDS.add(groups);
    timeline.setOptions(opts);
  }

  // viewport
  const r=(VIEW==='All'&&!forceFit)? null : rangeFor(VIEW);
  if(r){ timeline.setWindow(r.start, r.end, {animation:true}); } else if(forceFit || VIEW==='All'){ // improved Fit: margin 8%
    const range = items.filter(x=>!x.type).reduce((acc,it)=>{
      const s=new Date(it.start), e=new Date(it.end); if(s<acc.s)acc.s=s; if(e>acc.e)acc.e=e; return acc;
    },{s:new Date(8640000000000000), e:new Date(-8640000000000000)});
    const span = range.e - range.s; const pad = span*0.08; timeline.setWindow(new Date(range.s-pad), new Date(range.e+pad), {animation:true});
  }

  // patterns toggle
  $('#timeline').classList.toggle('patterned', PATTERNED);

  ensureDepSvg(); drawDepsSoon();
  $('#itemCount').textContent=`Items: ${items.filter(x=>!x.type).length}`;
}

function quarterMonthBands(){
  // bands across current window
  const w=viewWindow(); const s=new Date(w.start), e=new Date(w.end);
  const arr=[];
  // quarters
  const qs=new Date(s.getFullYear(), Math.floor(s.getMonth()/3)*3,1);
  for(let d=new Date(qs); d<=e; d=new Date(d.getFullYear(), d.getMonth()+3,1)){
    arr.push({id:'q_'+d.getTime(), start:iso(d), end:iso(new Date(d.getFullYear(), d.getMonth()+3,1)), type:'background', className:'qbg', content:`Q${Math.floor(d.getMonth()/3)+1} ${d.getFullYear()}`});
  }
  // months alternating
  const ms=new Date(s.getFullYear(), s.getMonth(),1); let togg=false;
  for(let d=new Date(ms); d<=e; d=new Date(d.getFullYear(), d.getMonth()+1,1)){
    arr.push({id:'m_'+d.getTime(), start:iso(d), end:iso(new Date(d.getFullYear(), d.getMonth()+1,1)), type:'background', className:(togg?'mbg-a':'mbg-b')});
    togg=!togg;
  }
  return arr;
}

/* Zoom slider → map to window width */
$('#zoomSlider').addEventListener('input',()=>{
  const w=viewWindow(); const center=(w.start.getTime()+w.end.getTime())/2;
  const spanDays = 10 + (365*6)* (1 - ($('#zoomSlider').value/100)); // 10 days .. ~6y
  const ms=spanDays*86400000/2; timeline.setWindow(new Date(center-ms), new Date(center+ms));
});

/* ===================== Priority Legend sync ===================== */
const prioLegend=document.getElementById('prioLegend');
prioLegend.addEventListener('click', e=>{
  const p=e.target.closest('.clickable'); if(!p) return;
  const val=p.dataset.prio; PRIO=(PRIO===val)? '' : val; $('#fPrio').value=PRIO; syncPrioLegend(); renderTable(); refreshTimeline();
});
function syncPrioLegend(){ prioLegend.querySelectorAll('.clickable').forEach(x=>x.classList.toggle('active', x.dataset.prio===PRIO && PRIO)); }

/* ===================== Build calendars (flatpickr) ===================== */
function buildPickers(){
  const opts=fpOpts();
  // Quick add
  if(qaStart){ qaStart.destroy(); qaDue.destroy(); }
  qaStart=flatpickr('#qaStart',{...opts, defaultDate:new Date()});
  qaDue=flatpickr('#qaDue',{...opts, defaultDate:new Date(new Date().setDate(new Date().getDate()+30))});
  // Modal
  if(mStart){ mStart.destroy(); mDue.destroy(); }
  mStart=flatpickr('#mStart',opts); mDue=flatpickr('#mDue',opts);
  // custom range
  if(rStart){ rStart.destroy(); rEnd.destroy(); }
  rStart=flatpickr('#rangeStart',opts); rEnd=flatpickr('#rangeEnd',opts);
}

/* ===================== Quick add & actions ===================== */
$('#qaAdd').onclick=()=>{
  const title=$('#qaTitle').value.trim(); if(!title) return alert('Title required');
  const s=$('#qaStart').value, d=$('#qaDue').value; if(!s||!d||s>d) return alert('Set valid dates');
  const g={id:crypto.randomUUID(), title, start_date:s, due_date:d, priority:$('#qaPrio').value, status:'planning', categoryId:$('#qaCat').value, tags:[], notes:'', links:[], recur:''};
  setGoals([...loadGoals(),g]); $('#qaTitle').value=''; refresh();
};

/* ===================== Keyboard shortcuts ===================== */
document.addEventListener('keydown',e=>{
  const open=modal.style.display==='flex' || $('#settingsModal').style.display==='flex';
  if(e.key==='Escape' && !open){ FOCUS.clear(); dimItems(); drawDepsSoon(); }
  if(!open){
    if(e.key==='/'){ e.preventDefault(); $('#search').focus(); }
    if(e.key==='n'||e.key==='N'){ openModal(); }
  }
});

/* ===================== Boot ===================== */
function refresh(){
  // dropdowns
  $('#qaCat').innerHTML=loadCats().map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  // pickers & notes
  buildPickers();
  if(!quill){ quill = new Quill('#mNotes',{theme:'snow'}); }
  // year buttons & table & status & timeline
  buildYears(); renderTable(); renderStatus(); refreshTimeline(); applyTheme();
  // persist filters (load once)
  const ui=loadUI(); const f=ui.filters||{};
  if(f.status) $('#fStatus').value=f.status; if(f.priority) { $('#fPrio').value=f.priority; PRIO=f.priority; syncPrioLegend(); }
  if(f.group) { GROUP=f.group; $('#groupMode').value=GROUP; }
  if(f.view) setView(f.view);
}
window.addEventListener('beforeunload',()=>{
  const ui=loadUI(); ui.filters={status:$('#fStatus').value, priority:PRIO||$('#fPrio').value, group:$('#groupMode').value, view:VIEW}; setUI(ui);
});
driver.init().then(refresh);
</script>
</body>
</html>
