<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Focus.One Lite</title>
<style>
  :root{
    --bg:#f7f9fc; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff;
    --blue:#0ea5e9; --blue-2:#60a5fa; --amber:#f59e0b; --red:#ef4444; --slate:#cbd5e1; --green:#22c55e; --violet:#8b5cf6;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  header{padding:14px 20px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .brand{font-weight:800;letter-spacing:.2px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--blue);color:#fff;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#e2e8f0;color:#0f172a}
  .btn.warn{background:var(--red)}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end}
  .g12{grid-column:span 12}.g6{grid-column:span 6}.g4{grid-column:span 4}.g3{grid-column:span 3}
  label{font-size:12px;color:#334155;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
  #gantt{overflow:auto;min-height:320px;border:1px solid var(--line);border-radius:12px;background:#fff;position:relative}
  .pill{display:inline-block;padding:3px 8px;border-radius:9999px;font-size:12px;font-weight:600}
  .id-pill{background:#eef2f7;color:#374151;border:1px solid #e5e7eb}
  .prio-low{background:#cbd5e1;color:#0f172a}
  .prio-medium{background:#60a5fa;color:#fff}
  .prio-high{background:#f59e0b;color:#fff}
  .prio-critical{background:#ef4444;color:#fff}
  .status-not_started{background:#e2e8f0;color:#0f172a}
  .status-in_progress{background:#8b5cf6;color:#fff}
  .status-blocked{background:#111827;color:#fff}
  .status-done{background:#22c55e;color:#fff}
  .axis{font-size:11px;fill:#475569}
  .label{font-size:12px}
  .no-data{text-align:center;color:var(--muted);padding:12px}
  .toolbar button.view-active{background:var(--blue-2);color:#fff}
  .category-pill{padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
  /* Year buttons */
  .year-filter{display:flex;gap:6px;flex-wrap:wrap}
  .year-filter .btn.year{background:#e2e8f0;color:#0f172a;padding:6px 10px;font-size:12px}
  .year-filter .btn.year.active{background:var(--blue-2);color:#fff}
  /* Quick add bar */
  .quick{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:8px}
  @media(max-width:900px){.quick{grid-template-columns:1fr 1fr 1fr 1fr 1fr auto}}
  @media(max-width:720px){.quick{grid-template-columns:1fr 1fr}}
  /* Modals */
  .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:15;backdrop-filter:blur(2px)}
  .backdrop.show{display:flex}
  .modal{width:min(720px, calc(100vw - 24px));background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);padding:16px;animation:pop .15s ease}
  @keyframes pop{from{transform:scale(.98);opacity:.6}to{transform:scale(1);opacity:1}}
  .modal header{position:static;border:0;padding:0 0 8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .modal .toolbar .btn.secondary.active{background:var(--blue-2);color:#fff}
  /* Status donut + legend */
  #statusMini{width:140px;height:140px}
  .legend-list{display:flex;gap:12px;flex-wrap:wrap}
  .legend-item{display:flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:2px;display:inline-block}
  /* Legend filters clickable */
  .legend .pill.clickable{cursor:pointer;opacity:.9}
  .legend .pill.clickable.active{outline:2px solid #0ea5e9}
  /* Dependency badge */
  .dep-badge{font-size:11px;color:#475569;background:#eef2f7;border:1px solid #e5e7eb;border-radius:999px;padding:2px 6px}
  /* Tooltip (SVG fallback uses <title>, but keep a CSS one for table) */
  .tooltip{position:relative}
  .tooltip:hover::after{
    content:attr(data-tip); position:absolute; left:0; top:100%;
    background:#111827;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap;transform:translateY(6px);
  }
</style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap row">
      <div class="brand">Focus.One <span class="muted">Lite</span></div>
      <div class="spacer"></div>
      <a class="btn secondary" href="dashboard.html">Dashboard</a>
      <a class="btn secondary" href="review.html">Quarterly Review</a>
      <button id="openSettingsBtn" class="btn secondary" type="button">Settings</button>
      <button id="exportJsonBtn" class="btn secondary" type="button">Export</button>
      <button id="importJsonBtn" class="btn secondary" type="button">Import</button>
      <button id="openAddBtn" class="btn" type="button">Add Goal</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Timeline -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2>Timeline</h2>
        <div class="toolbar" id="viewButtons">
          <!-- New views -->
          <button data-view="Week" class="btn secondary view-active" type="button">Week</button>
          <button data-view="1M"   class="btn secondary" type="button">1M</button>
          <button data-view="6M"   class="btn secondary" type="button">6M</button>
          <button data-view="YTD"  class="btn secondary" type="button">YTD</button>
          <button data-view="5Y"   class="btn secondary" type="button">5Y</button>
          <button data-view="All"  class="btn secondary" type="button">All</button>
        </div>
      </div>

      <div id="gantt"></div>
      <div class="legend" id="priorityLegend">
        <!-- Clickable priority filters -->
        <span class="pill prio-low clickable" data-prio="low">low</span>
        <span class="pill prio-medium clickable" data-prio="medium">medium</span>
        <span class="pill prio-high clickable" data-prio="high">high</span>
        <span class="pill prio-critical clickable" data-prio="critical">critical</span>
        <span class="muted" id="ganttCount" style="margin-left:8px;"></span>
      </div>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2>Status</h2>
        <div class="row" style="gap:16px;align-items:center">
          <canvas id="statusMini" width="140" height="140" aria-label="status donut"></canvas>
          <div id="statusLegend" class="legend-list"></div>
        </div>
      </div>
    </div>

    <!-- Goals -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:end;">
        <h2>Goals</h2>
        <div class="toolbar">
          <input id="searchBox" placeholder="Search title or category ( / )" style="min-width:220px"/>
          <select id="filterStatus" class="btn secondary">
            <option value="">All statuses</option>
            <option value="not_started">Not started</option>
            <option value="in_progress">In progress</option>
            <option value="blocked">Blocked</option>
            <option value="done">Done</option>
          </select>
          <select id="filterPriority" class="btn secondary">
            <option value="">All priorities</option>
            <option value="low">Low</option><option value="medium">Medium</option>
            <option value="high">High</option><option value="critical">Critical</option>
          </select>
          <div id="yearFilterTable" class="year-filter"></div>
          <button id="clearFiltersBtn" class="btn secondary" type="button">Clear</button>
        </div>
      </div>

      <!-- Quick Add -->
      <div class="quick" style="margin-top:12px;margin-bottom:10px;">
        <input id="qa_title" placeholder="Quick add: goal title" />
        <input id="qa_start" type="date" />
        <input id="qa_due" type="date" />
        <select id="qa_priority">
          <option>low</option><option selected>medium</option><option>high</option><option>critical</option>
        </select>
        <select id="qa_category"></select>
        <button id="qa_add" class="btn" type="button">Add</button>
      </div>

      <table>
        <thead><tr><th>ID</th><th>Title</th><th>Depends</th><th>Category</th><th>Start</th><th>Due</th><th>Priority</th><th>Status</th><th></th></tr></thead>
        <tbody id="goalRows"></tbody>
      </table>
    </div>

    <div class="muted" style="text-align:center;padding:18px">Data stored locally in your browser.</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="backdrop" class="backdrop" aria-modal="true" role="dialog">
    <div class="modal" role="document">
      <header class="row" style="justify-content:space-between;">
        <h2 id="modalTitle">Add Goal</h2>
        <button id="closeModalBtn" class="btn secondary" type="button">Close</button>
      </header>
      <div class="grid">
        <div class="g12">
          <label for="m_title">Title</label>
          <input id="m_title" placeholder="e.g., Finish German A2 by March" />
          <div class="muted" id="m_title_error"></div>
        </div>
        <div class="g6">
          <label for="m_start">Start date</label>
          <input id="m_start" type="date" />
          <div class="muted" id="m_start_error"></div>
        </div>
        <div class="g6">
          <label for="m_due">Due date</label>
          <input id="m_due" type="date" />
          <div class="muted" id="m_due_error"></div>
        </div>
        <div class="g6">
          <label for="m_category">Category</label>
          <select id="m_category"></select>
        </div>
        <div class="g6">
          <label for="m_depends">Depends on</label>
          <select id="m_depends"><option value="">None</option></select>
        </div>
        <div class="g6">
          <label for="m_priority">Priority</label>
          <select id="m_priority">
            <option>low</option><option selected>medium</option><option>high</option><option>critical</option>
          </select>
        </div>
        <div class="g6">
          <label for="m_status">Status</label>
          <select id="m_status">
            <option>not_started</option><option>in_progress</option><option>blocked</option><option>done</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="saveBtn" class="btn" type="button" disabled>Save</button>
      </div>
    </div>
  </div>

  <!-- Settings (General, Categories, Data) -->
  <div id="settingsBackdrop" class="backdrop" aria-modal="true" role="dialog">
    <div class="modal" role="document">
      <header class="row" style="justify-content:space-between;">
        <h2>Settings</h2>
        <button id="closeSettingsBtn" class="btn secondary" type="button">Close</button>
      </header>

      <div class="toolbar" style="margin-bottom:8px;">
        <button class="btn secondary active" data-tab="tabGeneral" type="button">General</button>
        <button class="btn secondary" data-tab="tabCategories" type="button">Categories</button>
        <button class="btn secondary" data-tab="tabData" type="button">Data</button>
      </div>

      <div id="tabGeneral" style="display:block;">
        <div class="grid">
          <div class="g6">
            <label>Appearance</label>
            <select id="settingTheme"><option value="auto">Auto</option><option value="light">Light</option><option value="dark">Dark</option></select>
            <div class="muted">Theme is a placeholder for next pass.</div>
          </div>
          <div class="g6">
            <label>Density</label>
            <select id="settingDensity"><option value="cozy">Cozy</option><option value="compact">Compact</option></select>
            <div class="muted">Density is a placeholder for next pass.</div>
          </div>
        </div>
      </div>

      <div id="tabCategories" style="display:none;">
        <div id="categoryList" style="margin-bottom:16px;"></div>
        <div class="actions"><button id="addCategoryBtn" class="btn" type="button">Add Category</button></div>
      </div>

      <div id="tabData" style="display:none;">
        <div class="grid">
          <div class="g12">
            <label>Backup / Restore</label>
            <div class="row">
              <button id="settingsExportBtn" class="btn secondary" type="button">Export JSON</button>
              <button id="settingsImportBtn" class="btn secondary" type="button">Import JSON</button>
            </div>
          </div>
          <div class="g12" style="margin-top:12px;">
            <label>Danger zone</label>
            <button id="deleteAllBtn" class="btn warn" type="button">Delete EVERYTHING</button>
            <div class="muted">Removes all goals & categories from this browser. Cannot be undone.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== Utilities & Storage ===================== */
const $ = s => document.querySelector(s);
const goalsKey='focusone_goals', categoriesKey='focusone_categories';

function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function uid(){ return 'g_' + Math.random().toString(36).slice(2,9); }
function formatGoalID(i){ return 'G' + String(i).padStart(2,'0'); }
function loadGoals(){ try{ return JSON.parse(localStorage.getItem(goalsKey))||[] }catch{ return [] } }
function loadCategories(){ try{ return JSON.parse(localStorage.getItem(categoriesKey))||[] }catch{ return [] } }
function setGoals(v){ localStorage.setItem(goalsKey, JSON.stringify(v)); }
function setCategories(v){ localStorage.setItem(categoriesKey, JSON.stringify(v)); }

/* ===================== Defaults (safe) ===================== */
(function initDefaults(){
  if(loadCategories().length===0){
    setCategories([
      { id:uid(), name:'Wealth', color:'#4b5563' },
      { id:uid(), name:'Language', color:'#2563eb' },
      { id:uid(), name:'Immigration', color:'#d97706' },
      { id:uid(), name:'Career', color:'#16a34a' },
      { id:uid(), name:'Business', color:'#0d9488' },
      { id:uid(), name:'Health', color:'#dc2626' },
      { id:uid(), name:'Relationship', color:'#9333ea' },
      { id:uid(), name:'Real Estate', color:'#f59e0b' },
      { id:uid(), name:'Creative', color:'#f43f5e' },
      { id:uid(), name:'Other', color:'#6b7280' }
    ]);
  }
  if(loadGoals().length===0){
    const today=new Date();
    const inDays=d=>{ const x=new Date(today); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
    const catId=loadCategories()[0].id;
    setGoals([
      { id:uid(), title:'German A2 course',      start_date:inDays(0),   due_date:inDays(60),  categoryId:catId, priority:'high',    status:'in_progress' },
      { id:uid(), title:'SQM book — 2 chapters', start_date:inDays(7),   due_date:inDays(120), categoryId:catId, priority:'medium',  status:'not_started' },
      { id:uid(), title:'Gym — 52 sessions',     start_date:inDays(-14), due_date:inDays(168), categoryId:catId, priority:'critical',status:'not_started' }
    ]);
  }
})();

/* ===================== Global State ===================== */
let currentView='Week'; // Week, 1M, 6M, YTD, 5Y, All
let filterYearTable='';      // year or YTD or ''
let filterPriorityGlobal=''; // clicking the legend sets this for both table & timeline
let lastUsedCategoryId=null;

/* ===================== Settings Modal ===================== */
const settingsBackdrop = $('#settingsBackdrop');
$('#openSettingsBtn').onclick=()=>{ switchTab('tabGeneral'); settingsBackdrop.classList.add('show'); };
$('#closeSettingsBtn').onclick=()=> settingsBackdrop.classList.remove('show');
const tabBtns = document.querySelectorAll('#settingsBackdrop .toolbar .btn');
tabBtns.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function switchTab(id){
  tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  ['tabGeneral','tabCategories','tabData'].forEach(x=>{
    document.getElementById(x).style.display = (x===id?'block':'none');
  });
  if(id==='tabCategories') renderCategoryList();
}
$('#settingsExportBtn').onclick=()=>$('#exportJsonBtn').click();
$('#settingsImportBtn').onclick=()=>$('#importJsonBtn').click();
$('#deleteAllBtn').onclick=()=>{
  const sure=prompt('Type DELETE to remove ALL goals & categories.');
  if(sure==='DELETE'){
    localStorage.removeItem(goalsKey);
    localStorage.removeItem(categoriesKey);
    setCategories([{id:uid(), name:'Other', color:'#6b7280'}]);
    setGoals([]);
    refreshAll();
    alert('All data deleted.');
  }
};

/* ===================== Add/Edit Modal ===================== */
const backdrop=$('#backdrop'); let editingId=null;
const fields = {
  title:$('#m_title'), start:$('#m_start'), due:$('#m_due'),
  category:$('#m_category'), depends:$('#m_depends'),
  priority:$('#m_priority'), status:$('#m_status')
};
const errs={ title:$('#m_title_error'), start:$('#m_start_error'), due:$('#m_due_error') };
const saveBtn=$('#saveBtn');

function openModal(goal={}){
  editingId = goal.id || null;
  $('#modalTitle').textContent = editingId?'Edit Goal':'Add Goal';
  populateCategorySelect();
  populateDependsSelect();
  fields.title.value = goal.title||'';
  fields.start.value = goal.start_date||'';
  fields.due.value   = goal.due_date||'';
  fields.category.value = goal.categoryId || (lastUsedCategoryId || fields.category.value);
  fields.depends.value  = goal.dependsOnId || '';
  fields.priority.value = goal.priority || 'medium';
  fields.status.value   = goal.status || 'not_started';
  Object.values(errs).forEach(e=>e.textContent='');
  saveBtn.disabled=true;
  backdrop.classList.add('show');
  fields.title.focus();
}
function closeModal(){ backdrop.classList.remove('show'); editingId=null; saveBtn.disabled=true; }
$('#openAddBtn').onclick=()=>openModal();
$('#closeModalBtn').onclick=closeModal;
window.addEventListener('keydown',e=>{
  const anInput = /input|textarea|select/i.test((e.target||{}).tagName||'');
  if(e.key==='Escape'){ if(backdrop.classList.contains('show')) closeModal(); if(settingsBackdrop.classList.contains('show')) settingsBackdrop.classList.remove('show'); }
  if(!anInput && !backdrop.classList.contains('show') && !settingsBackdrop.classList.contains('show')){
    if(e.key==='n') openModal();
    if(e.key==='/'){ e.preventDefault(); $('#searchBox').focus(); }
    if(e.key==='s') $('#openSettingsBtn').click();
    // view keys: 1=Week 2=1M 3=6M 4=YTD 5=5Y 6=All
    if(e.key==='1') setView('Week');
    if(e.key==='2') setView('1M');
    if(e.key==='3') setView('6M');
    if(e.key==='4') setView('YTD');
    if(e.key==='5') setView('5Y');
    if(e.key==='6') setView('All');
  }
});

['m_start','m_due'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('change',()=>el.blur()); });

function populateCategorySelect(){
  const cats=loadCategories();
  fields.category.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(!fields.category.value){ const other=cats.find(c=>c.name==='Other')||cats[0]; if(other) fields.category.value=other.id; }
}
function populateDependsSelect(){
  const goals=loadGoals();
  fields.depends.innerHTML = `<option value="">None</option>` + goals.map(g=>`<option value="${g.id}">${escapeHtml(g.title)}</option>`).join('');
}
function validateForm(){
  let ok=true;
  if(!fields.title.value.trim()){ errs.title.textContent='Title is required.'; ok=false; } else errs.title.textContent='';
  if(!fields.start.value){ errs.start.textContent='Start date is required.'; ok=false; } else errs.start.textContent='';
  if(!fields.due.value){ errs.due.textContent='Due date is required.'; ok=false; }
  else if(fields.start.value && fields.start.value>fields.due.value){ errs.due.textContent='Due must be after start.'; ok=false; } else errs.due.textContent='';
  saveBtn.disabled=!ok;
}
Object.values(fields).forEach(el=>{ el.addEventListener('input',validateForm); el.addEventListener('change',validateForm); });
saveBtn.onclick=()=>{
  const d={
    title:fields.title.value.trim(),
    start_date:fields.start.value, due_date:fields.due.value,
    categoryId:fields.category.value, dependsOnId:fields.depends.value||null,
    priority:fields.priority.value, status:fields.status.value
  };
  lastUsedCategoryId = d.categoryId;
  const list=loadGoals();
  if(editingId) setGoals(list.map(g=>g.id===editingId?{...g,...d}:g));
  else { setGoals([...list, {id:uid(), ...d}]); }
  refreshAll(); closeModal();
};

/* ===================== Manage Categories (Settings) ===================== */
function renderCategoryList(){
  const el=$('#categoryList'), cats=loadCategories();
  el.innerHTML = cats.map(c=>`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <input class="cat-name" data-id="${c.id}" type="text" value="${escapeHtml(c.name)}" style="flex:1;padding:6px;border:1px solid var(--line);border-radius:6px;" />
      <input class="cat-color" data-id="${c.id}" type="color" value="${c.color}" />
      <button class="btn warn cat-del" data-id="${c.id}" type="button">Delete</button>
    </div>`).join('');
  el.querySelectorAll('.cat-name').forEach(inp=>inp.onchange=()=>{
    const id=inp.dataset.id; setCategories(loadCategories().map(c=>c.id===id?{...c,name:inp.value.trim()||c.name}:c)); refreshAll(); renderCategoryList();
  });
  el.querySelectorAll('.cat-color').forEach(inp=>inp.onchange=()=>{
    const id=inp.dataset.id; setCategories(loadCategories().map(c=>c.id===id?{...c,color:inp.value}:c)); refreshAll();
  });
  el.querySelectorAll('.cat-del').forEach(btn=>btn.onclick=()=>{
    if(!confirm('Delete this category and reassign goals to "Other"?')) return;
    const id=btn.dataset.id;
    let cats=loadCategories().filter(c=>c.id!==id);
    if(cats.length===0) cats=[{id:uid(),name:'Other',color:'#6b7280'}];
    const other=cats.find(c=>c.name==='Other')||cats[0];
    setCategories(cats);
    setGoals(loadGoals().map(g=>g.categoryId===id?{...g,categoryId:other.id}:g));
    refreshAll(); renderCategoryList();
  });
}
$('#addCategoryBtn').onclick=()=>{
  const name=prompt('New category name:'); if(!name) return;
  const color=prompt('Hex color (e.g. #1f2937):','#6b7280'); if(!/^#[0-9a-f]{6}$/i.test(color)) return alert('Invalid color');
  setCategories([...loadCategories(), {id:uid(), name:name.trim(), color}]); refreshAll(); renderCategoryList();
};

/* ===================== Export / Import ===================== */
$('#exportJsonBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify({goals:loadGoals(), categories:loadCategories()}, null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='focusone-data.json'; a.click(); URL.revokeObjectURL(url);
};
$('#importJsonBtn').onclick=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=()=>{
    const f=input.files[0]; if(!f) return; const fr=new FileReader();
    fr.onload=()=>{
      try{
        const d=JSON.parse(fr.result);
        if(Array.isArray(d.goals) && Array.isArray(d.categories)){
          if(confirm('Replace existing data?')){ setCategories(d.categories); setGoals(d.goals); }
          else {
            const cats0=loadCategories(); const mergedCats=[...cats0, ...d.categories.filter(c=>!cats0.find(x=>x.id===c.id))]; setCategories(mergedCats);
            const goals0=loadGoals(); const mergedGoals=[...goals0, ...d.goals.map(g=>({...g,id:uid()}))]; setGoals(mergedGoals);
          }
          refreshAll();
        } else alert('Invalid JSON format');
      }catch{ alert('Invalid JSON'); }
    };
    fr.readAsText(f);
  };
  input.click();
};

/* ===================== Filters: Search, Status, Priority, Year (incl. YTD) ===================== */
const searchBox=$('#searchBox'), filterStatus=$('#filterStatus'), filterPriority=$('#filterPriority');
const yearUI_tb=$('#yearFilterTable');

function buildYearUI(container, years, current, onChange){
  container.innerHTML=''; if(years.length===0) return;
  const MAX_BTN=8;
  // Always include YTD + All
  const makeBtn=(label,val)=>{ const b=document.createElement('button'); b.type='button'; b.className='btn year'+(current===val?' active':''); b.textContent=label; b.onclick=()=>{ onChange(val); container.querySelectorAll('.btn.year').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }; return b; };
  container.appendChild(makeBtn('All',''));
  container.appendChild(makeBtn('YTD','YTD'));
  if(years.length<=MAX_BTN){
    years.forEach(y=> container.appendChild(makeBtn(y,y)));
  } else {
    const sel=document.createElement('select'); sel.className='btn secondary';
    sel.appendChild(new Option('Pick year',''));
    years.forEach(y=> sel.appendChild(new Option(y,y)));
    sel.value=(current && current!=='YTD')?current:'';
    sel.onchange=()=>onChange(sel.value);
    container.appendChild(sel);
  }
}
function rebuildYearFilters(){
  const years = Array.from(new Set(loadGoals().flatMap(g=>{
    const ys=[]; if(g.start_date) ys.push(g.start_date.slice(0,4)); if(g.due_date) ys.push(g.due_date.slice(0,4)); return ys;
  }))).sort();
  buildYearUI(yearUI_tb, years, filterYearTable, (v)=>{ filterYearTable=v; renderTable(); });
}
$('#clearFiltersBtn').onclick=()=>{ searchBox.value=''; filterStatus.value=''; filterPriority.value=''; filterYearTable=''; filterPriorityGlobal=''; syncLegendPriority(); rebuildYearFilters(); renderTable(); drawGantt(); renderSummary(); };
searchBox.oninput=renderTable; filterStatus.onchange=renderTable; filterPriority.onchange=()=>{ filterPriorityGlobal=filterPriority.value; syncLegendPriority(); renderTable(); drawGantt(); };

/* ===================== Quick Add ===================== */
const qa={ title:$('#qa_title'), start:$('#qa_start'), due:$('#qa_due'), prio:$('#qa_priority'), cat:$('#qa_category'), add:$('#qa_add') };
(function initQuick(){
  const today=new Date(); const pad=n=>String(n).padStart(2,'0');
  const dstr=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const start=new Date(); const due=new Date(); due.setDate(start.getDate()+30);
  qa.start.value=dstr(start); qa.due.value=dstr(due);
  const cats=loadCategories(); qa.cat.innerHTML=cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(lastUsedCategoryId) qa.cat.value=lastUsedCategoryId;
})();
qa.add.onclick=()=>{
  const title=qa.title.value.trim(); if(!title) return alert('Title is required.');
  if(!qa.start.value || !qa.due.value) return alert('Set both start & due.');
  if(qa.start.value>qa.due.value) return alert('Start must be before or equal Due.');
  const g={ id:uid(), title, start_date:qa.start.value, due_date:qa.due.value, priority:qa.prio.value, categoryId:qa.cat.value, status:'not_started' };
  setGoals([...loadGoals(), g]); lastUsedCategoryId=g.categoryId; qa.title.value=''; refreshAll();
};

/* ===================== Table (render + single-click inline edit + dependencies) ===================== */
function formatIdMap(list){ return new Map(list.map((g,i)=>[g.id, formatGoalID(i+1)])); }
function renderTable(){
  const cats=loadCategories(), fs=filterStatus.value, fpSel=filterPriority.value, fy=filterYearTable;
  const q=(searchBox.value||'').toLowerCase();
  const fp = filterPriorityGlobal || fpSel; // global from legend overrides select
  const todayISO=new Date().toISOString().slice(0,10);
  const yearStart = new Date(new Date().getFullYear(),0,1).toISOString().slice(0,10);

  const list = loadGoals().filter(g=>{
    if(q){
      const catName = cats.find(c=>c.id===g.categoryId)?.name || '';
      if(!g.title.toLowerCase().includes(q) && !catName.toLowerCase().includes(q)) return false;
    }
    if(fs && g.status!==fs) return false;
    if(fp && g.priority!==fp) return false;
    if(fy==='YTD'){
      // Any overlap with [yearStart, today]
      const start=g.start_date||'9999-12-31'; const end=g.due_date||'0000-01-01';
      if(!(end>=yearStart && start<=todayISO)) return false;
    } else if(fy){
      const sy=g.start_date?.slice(0,4), dy=g.due_date?.slice(0,4); if(sy!==fy && dy!==fy) return false;
    }
    return true;
  });

  const tbody=$('#goalRows');
  if(list.length===0){ tbody.innerHTML='<tr><td colspan="9" class="no-data">No goals match your filters.</td></tr>'; return; }
  const idMap = formatIdMap(loadGoals());

  tbody.innerHTML = list.map(g=>{
    const cat=cats.find(c=>c.id===g.categoryId)||{name:'Other',color:'#6b7280'};
    const dep = g.dependsOnId ? idMap.get(g.dependsOnId) : '';
    return `<tr data-id="${g.id}">
      <td><span class="id-pill">${idMap.get(g.id)}</span></td>
      <td data-field="title" class="tooltip" data-tip="${escapeHtml(g.title)}">
        ${escapeHtml(g.title)}
        ${dep ? `<span class="dep-badge" title="Depends on ${dep}">↳ ${dep}</span>`:''}
      </td>
      <td>${dep? `<span class="dep-badge" title="Depends on ${dep}">${dep}</span>`:''}</td>
      <td data-field="categoryId"><span class="category-pill" style="background:${cat.color}">${escapeHtml(cat.name)}</span></td>
      <td data-field="start_date">${g.start_date||''}</td>
      <td data-field="due_date">${g.due_date||''}</td>
      <td data-field="priority"><span class="pill prio-${g.priority}">${g.priority}</span></td>
      <td data-field="status"><span class="pill status-${g.status}">${g.status.replace('_',' ')}</span></td>
      <td class="row" style="gap:4px;">
        <button class="btn secondary" data-edit="${g.id}" type="button">Edit</button>
        <button class="btn warn" data-del="${g.id}" type="button">Delete</button>
      </td>
    </tr>`;
  }).join('');

  // Single-click inline edit on cells
  tbody.querySelectorAll('td[data-field]').forEach(td=>{
    td.onclick = () => startInlineEdit(td);
  });

  // Buttons
  tbody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=e=>{
    e.stopPropagation(); const id=b.dataset.edit; const g=loadGoals().find(x=>x.id===id); if(g) openModal(g);
  });
  tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick=e=>{
    e.stopPropagation(); const id=b.dataset.del;
    if(confirm('Delete this goal?')){ setGoals(loadGoals().filter(g=>g.id!==id)); refreshAll(); }
  });
}
function startInlineEdit(td){
  const tr=td.closest('tr'); const id=tr.dataset.id; const field=td.dataset.field;
  const goals=loadGoals(); const g=goals.find(x=>x.id===id); if(!g) return;

  let editor;
  const commit = (val)=>{
    const updated={...g, [field]:val};
    if(updated.start_date && updated.due_date && updated.start_date>updated.due_date){
      alert('Start must be before or equal Due.'); renderTable(); return;
    }
    setGoals(goals.map(x=>x.id===id?updated:x)); refreshAll();
  };
  const cancel = ()=> renderTable();

  if(field==='title'){
    editor=document.createElement('input'); editor.value=g.title; editor.style.width='100%';
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value.trim()); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value.trim());
    td.innerHTML=''; td.appendChild(editor); editor.focus(); editor.select();
  } else if(field==='start_date' || field==='due_date'){
    editor=document.createElement('input'); editor.type='date'; editor.value=g[field]||''; editor.style.width='100%';
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='priority'){
    editor=document.createElement('select'); ['low','medium','high','critical'].forEach(p=>editor.appendChild(new Option(p,p,p===g.priority,p===g.priority)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='status'){
    const opts=['not_started','in_progress','blocked','done'];
    editor=document.createElement('select'); opts.forEach(p=>editor.appendChild(new Option(p,p,p===g.status,p===g.status)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='categoryId'){
    editor=document.createElement('select'); loadCategories().forEach(c=>editor.appendChild(new Option(c.name,c.id,c.id===g.categoryId,c.id===g.categoryId)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  }
}

/* ===================== Status (donut + numbered legend) ===================== */
function renderSummary(){
  const list=loadGoals();
  const counts={
    not_started:list.filter(g=>g.status==='not_started').length,
    in_progress:list.filter(g=>g.status==='in_progress').length,
    blocked:list.filter(g=>g.status==='blocked').length,
    done:list.filter(g=>g.status==='done').length
  };
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const pctDone = total? Math.round(counts.done/total*100) : 0;

  // Donut
  const canvas=document.getElementById('statusMini'); const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const values=[counts.not_started, counts.in_progress, counts.blocked, counts.done];
  const colors=['#e2e8f0','#8b5cf6','#111827','#22c55e'];
  const labels=['Not started','In progress','Blocked','Done'];
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-4, inner=r*0.6;
  let start=-Math.PI/2;
  if(total===0){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#e5e7eb'; ctx.fill(); }
  else {
    values.forEach((v,i)=>{ const a=(v/total)*2*Math.PI; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+a); ctx.closePath(); ctx.fillStyle=colors[i]; ctx.fill(); start+=a; });
  }
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
  ctx.fillStyle='#0f172a'; ctx.font='700 18px system-ui,-apple-system,Segoe UI,Roboto,sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(pctDone+'%', cx, cy);

  // Legend with numbers & %
  const legend=$('#statusLegend'); legend.innerHTML='';
  labels.forEach((lab,i)=>{
    const v=values[i]; const p= total? Math.round(v/total*100):0;
    const div=document.createElement('div'); div.className='legend-item';
    div.innerHTML=`<span class="dot" style="background:${colors[i]}"></span><span>${lab}: <b>${v}</b> (${p}%)</span>`;
    legend.appendChild(div);
  });
}

/* ===================== Timeline (SVG) with new views, quarter markers, labels, dependency arrows ===================== */
function setView(v){ currentView=v; document.querySelectorAll('#viewButtons button').forEach(b=>b.classList.toggle('view-active', b.dataset.view===v)); drawGantt(); }
document.getElementById('viewButtons').addEventListener('click', e=>{
  if(e.target.matches('button[data-view]')) setView(e.target.dataset.view);
});

function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function daysBetween(a,b){ return Math.max(0, Math.ceil((new Date(b)-new Date(a))/86400000)); }
function clampDate(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function monthLabel(x){ return x.toLocaleString(undefined,{month:'short',year:'numeric'}); }
function startOfQuarter(date){ const q=Math.floor(date.getMonth()/3); return new Date(date.getFullYear(), q*3, 1); }
function nextQuarterStart(date){ const q=Math.floor(date.getMonth()/3); return new Date(date.getFullYear(), (q+1)*3, 1); }

function getRangeForView(view){
  const today=new Date(); const y=today.getFullYear();
  const start=today;
  let end;
  switch(view){
    case 'Week': end=addDays(today,7); break;
    case '1M': { const e=new Date(today); e.setMonth(e.getMonth()+1); end=e; break; }
    case '6M': { const e=new Date(today); e.setMonth(e.getMonth()+6); end=e; break; }
    case 'YTD': end=new Date(y,11,31); break;
    case '5Y': { const e=new Date(today); e.setFullYear(e.getFullYear()+5); end=e; break; }
    case 'All':
    default: return null; // All = auto-fit
  }
  return {start:clampDate(start), end:clampDate(end)};
}

function drawGantt(){
  const container=$('#gantt'), countEl=$('#ganttCount');
  const cats=loadCategories();
  let items=loadGoals().filter(g=>g.start_date && g.due_date);

  // Apply priority filter (from legend or select)
  if(filterPriorityGlobal){
    items = items.filter(g=>g.priority===filterPriorityGlobal);
  }

  container.innerHTML='';
  if(items.length===0){ container.innerHTML='<div class="no-data">No items to plot.</div>'; countEl.textContent='Items: 0'; return; }
  countEl.textContent='Items: '+items.length;

  // Determine range
  let minDate, maxDate;
  const viewRange = getRangeForView(currentView);
  if(currentView==='All' || !viewRange){
    minDate = items.reduce((m,g)=> g.start_date<m?g.start_date:m, items[0].start_date);
    maxDate = items.reduce((m,g)=> g.due_date>m?g.due_date:m, items[0].due_date);
    minDate = addDays(minDate,-7);
    maxDate = addDays(maxDate, 7);
  } else {
    minDate = viewRange.start; maxDate = viewRange.end;
  }

  const total=daysBetween(minDate,maxDate);
  // Zoom by view
  const pxPerDay = (currentView==='Week')? 28
                   : (currentView==='1M')? 16
                   : (currentView==='6M')? 8
                   : (currentView==='YTD')? 6
                   : (currentView==='5Y')? 2.4
                   : 8;
  const height=60 + items.length*36, width=120 + Math.max(240, total*pxPerDay);

  const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',Math.max(width, container.clientWidth));
  svg.setAttribute('height',height);

  // Quarter markers (Q1..Q4)
  const qStart = new Date(minDate.getFullYear(), Math.floor(minDate.getMonth()/3)*3, 1);
  for(let d=new Date(qStart); d<=maxDate; d=nextQuarterStart(d)){
    const offset=daysBetween(minDate, d)*pxPerDay;
    const x=100+offset;
    const l=document.createElementNS(NS,'line');
    l.setAttribute('x1',x); l.setAttribute('y1',24); l.setAttribute('x2',x); l.setAttribute('y2',height);
    l.setAttribute('stroke','#e2e8f0'); l.setAttribute('stroke-width','1'); svg.appendChild(l);

    const qIndex=Math.floor(d.getMonth()/3)+1;
    const t=document.createElementNS(NS,'text');
    t.setAttribute('x',x+4); t.setAttribute('y',16); t.setAttribute('class','axis');
    t.textContent=`Q${qIndex} ${d.getFullYear()}`;
    svg.appendChild(t);
  }

  // Today marker
  const now=new Date();
  if(now>=minDate && now<=maxDate){
    const off=daysBetween(minDate,now)*pxPerDay, x=100+off;
    const l=document.createElementNS(NS,'line'); l.setAttribute('x1',x); l.setAttribute('y1',24); l.setAttribute('x2',x); l.setAttribute('y2',height);
    l.setAttribute('stroke','#ef4444'); l.setAttribute('stroke-width','2'); l.setAttribute('stroke-dasharray','4 2'); svg.appendChild(l);
    const t=document.createElementNS(NS,'text'); t.setAttribute('x',x+4); t.setAttribute('y',16); t.setAttribute('class','axis'); t.textContent='Today'; svg.appendChild(t);
  }

  // Bars with short labels, keep a map of coords for dependency arrows
  const barMap=new Map();
  const idMap=formatIdMap(loadGoals());

  items.forEach((g,i)=>{
    const y=36 + i*36;
    const s = new Date(g.start_date), e = new Date(g.due_date);
    // draw only if intersects the range
    if(e < minDate || s > maxDate) return;

    const startOff=daysBetween(minDate, (s<minDate?minDate:s));
    const barX=100 + startOff*pxPerDay;
    const drawStart = (s<minDate?minDate:s);
    const drawEnd   = (e>maxDate?maxDate:e);
    const barW=Math.max(6, daysBetween(drawStart, drawEnd)*pxPerDay);

    const rect=document.createElementNS(NS,'rect');
    rect.setAttribute('x',barX); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',22);
    rect.setAttribute('rx',6); rect.setAttribute('ry',6);
    const cat=cats.find(c=>c.id===g.categoryId)||{color:'#6b7280'};
    rect.setAttribute('fill',cat.color); rect.setAttribute('fill-opacity', g.status==='done'?'0.8':'1.0');
    rect.setAttribute('stroke','#0f172a22'); rect.setAttribute('stroke-width','1'); rect.style.cursor='pointer';
    rect.addEventListener('click',()=>{ const g0=loadGoals().find(x=>x.id===g.id); if(g0) openModal(g0); });
    const tt=document.createElementNS(NS,'title');
    tt.textContent = `${g.title}\n${g.start_date} → ${g.due_date}\n${g.priority.toUpperCase()} • ${g.status.replace('_',' ')}`;
    rect.appendChild(tt);
    svg.appendChild(rect);

    // Short label on bar
    const short = (g.title.length>18)? g.title.slice(0,16)+'…' : g.title;
    const tx=document.createElementNS(NS,'text');
    tx.setAttribute('x',barX+6); tx.setAttribute('y',y+15); tx.setAttribute('fill','#fff'); tx.setAttribute('font-size','12'); tx.setAttribute('font-weight','600');
    tx.textContent = short;
    svg.appendChild(tx);

    barMap.set(g.id, { x:barX, y:y, w:barW });
  });

  // Dependency arrows
  items.forEach(g=>{
    if(!g.dependsOnId) return;
    const from=barMap.get(g.dependsOnId), to=barMap.get(g.id);
    if(!from || !to) return;
    const x1 = from.x + from.w, y1 = from.y + 11;
    const x2 = to.x,           y2 = to.y + 11;
    const path=document.createElementNS(NS,'path');
    const midX = (x1 + x2)/2;
    const d = `M ${x1} ${y1} C ${midX} ${y1} ${midX} ${y2} ${x2} ${y2}`;
    path.setAttribute('d', d);
    path.setAttribute('stroke', '#475569'); path.setAttribute('stroke-width', '1.5'); path.setAttribute('fill','none'); path.setAttribute('stroke-dasharray','3 2');
    svg.appendChild(path);
    // arrow head
    const tri=document.createElementNS(NS,'path');
    tri.setAttribute('d', `M ${x2-6} ${y2-4} L ${x2} ${y2} L ${x2-6} ${y2+4} Z`);
    tri.setAttribute('fill','#475569');
    svg.appendChild(tri);
  });

  container.appendChild(svg);
}

/* ===================== Priority Legend (click to filter both timeline & table) ===================== */
const legendEl=document.getElementById('priorityLegend');
legendEl.addEventListener('click', e=>{
  const btn = e.target.closest('.clickable'); if(!btn) return;
  const pr = btn.dataset.prio;
  filterPriorityGlobal = (filterPriorityGlobal===pr)? '' : pr;
  syncLegendPriority();
  // also sync the table select
  filterPriority.value = filterPriorityGlobal;
  renderTable(); drawGantt();
});
function syncLegendPriority(){
  legendEl.querySelectorAll('.clickable').forEach(x=>{
    x.classList.toggle('active', x.dataset.prio===filterPriorityGlobal && filterPriorityGlobal!=='');
  });
}

/* ===================== Refresh & Boot ===================== */
function refreshAll(){
  rebuildYearFilters();
  renderTable();
  drawGantt();
  renderSummary();
  syncLegendPriority();
  // refresh quick add category list (preserve selection if possible)
  const cats=loadCategories();
  const qaSel=$('#qa_category'); const cur=qaSel.value;
  qaSel.innerHTML=cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(lastUsedCategoryId) qaSel.value=lastUsedCategoryId; else if(cur) qaSel.value=cur;
}
document.addEventListener('DOMContentLoaded', refreshAll);
</script>
</body>
</html>
