<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Focus.One Lite</title>
<style>
  :root{
    --bg:#f7f9fc; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --card:#ffffff;
    --blue:#0ea5e9; --blue-2:#60a5fa; --amber:#f59e0b; --red:#ef4444; --slate:#cbd5e1; --green:#22c55e; --violet:#8b5cf6;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
  header{padding:14px 20px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .brand{font-weight:800;letter-spacing:.2px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .btn{padding:10px 14px;border-radius:12px;border:0;background:var(--blue);color:#fff;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}
  .btn.secondary{background:#e2e8f0;color:#0f172a}
  .btn.warn{background:var(--red)}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end}
  .g12{grid-column:span 12}.g6{grid-column:span 6}.g4{grid-column:span 4}.g3{grid-column:span 3}
  label{font-size:12px;color:#334155;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
  #gantt{overflow:auto;min-height:280px;border:1px solid var(--line);border-radius:12px;background:#fff;position:relative}
  .pill{display:inline-block;padding:3px 8px;border-radius:9999px;font-size:12px;font-weight:600}
  .prio-low{background:#cbd5e1;color:#0f172a}
  .prio-medium{background:#60a5fa;color:#fff}
  .prio-high{background:#f59e0b;color:#fff}
  .prio-critical{background:#ef4444;color:#fff}
  .status-not_started{background:#e2e8f0;color:#0f172a}
  .status-in_progress{background:#8b5cf6;color:#fff}
  .status-blocked{background:#111827;color:#fff}
  .status-done{background:#22c55e;color:#fff}
  .axis{font-size:11px;fill:#475569}
  .label{font-size:12px}
  .no-data{text-align:center;color:var(--muted);padding:12px}
  .toolbar button.view-active{background:var(--blue-2);color:#fff}
  .category-pill{padding:3px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
  /* Year buttons */
  .year-filter{display:flex;gap:6px;flex-wrap:wrap}
  .year-filter .btn.year{background:#e2e8f0;color:#0f172a;padding:6px 10px;font-size:12px}
  .year-filter .btn.year.active{background:var(--blue-2);color:#fff}
  /* Quick add bar */
  .quick{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr auto;gap:8px}
  @media(max-width:900px){.quick{grid-template-columns:1fr 1fr 1fr 1fr 1fr auto}}
  @media(max-width:720px){.quick{grid-template-columns:1fr 1fr;}}
  /* Modals */
  .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:15;backdrop-filter:blur(2px)}
  .backdrop.show{display:flex}
  .modal{width:min(720px, calc(100vw - 24px));background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.18);padding:16px;animation:pop .15s ease}
  @keyframes pop{from{transform:scale(.98);opacity:.6}to{transform:scale(1);opacity:1}}
  .modal header{position:static;border:0;padding:0 0 8px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .modal .toolbar .btn.secondary.active{background:var(--blue-2);color:#fff}
  /* Status donut */
  #statusMini{width:120px;height:120px}
</style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap row">
      <div class="brand">Focus.One <span class="muted">Lite</span></div>
      <div class="spacer"></div>
      <a class="btn secondary" href="dashboard.html">Dashboard</a>
      <a class="btn secondary" href="review.html">Quarterly Review</a>
      <button id="openSettingsBtn" class="btn secondary" type="button">Settings</button>
      <button id="exportJsonBtn" class="btn secondary" type="button">Export</button>
      <button id="importJsonBtn" class="btn secondary" type="button">Import</button>
      <button id="openAddBtn" class="btn" type="button">Add Goal</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Timeline -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2>Timeline</h2>
        <div class="toolbar" id="viewButtons">
          <button data-view="Month" class="btn secondary view-active" type="button">Month</button>
          <button data-view="Quarter" class="btn secondary" type="button">Quarter</button>
          <button data-view="Year" class="btn secondary" type="button">Year</button>
          <div id="yearFilterTimeline" class="year-filter"></div>
        </div>
      </div>
      <div id="gantt"></div>
      <div class="legend">
        <span class="pill prio-low">low</span>
        <span class="pill prio-medium">medium</span>
        <span class="pill prio-high">high</span>
        <span class="pill prio-critical">critical</span>
        <span class="muted" id="ganttCount"></span>
      </div>
    </div>

    <!-- Status -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h2>Status</h2>
        <div class="row" style="gap:12px;align-items:center">
          <canvas id="statusMini" width="120" height="120" aria-label="status donut"></canvas>
        </div>
      </div>
      <div id="statusSummary" class="summary" style="margin-top:10px"></div>
    </div>

    <!-- Goals -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:end;">
        <h2>Goals</h2>
        <div class="toolbar">
          <input id="searchBox" placeholder="Search title or category ( / )" style="min-width:220px"/>
          <select id="filterStatus" class="btn secondary">
            <option value="">All statuses</option>
            <option value="not_started">Not started</option>
            <option value="in_progress">In progress</option>
            <option value="blocked">Blocked</option>
            <option value="done">Done</option>
          </select>
          <select id="filterPriority" class="btn secondary">
            <option value="">All priorities</option>
            <option value="low">Low</option><option value="medium">Medium</option>
            <option value="high">High</option><option value="critical">Critical</option>
          </select>
          <div id="yearFilterTable" class="year-filter"></div>
          <button id="clearFiltersBtn" class="btn secondary" type="button">Clear</button>
        </div>
      </div>

      <!-- Quick Add -->
      <div class="quick" style="margin-top:12px;margin-bottom:10px;">
        <input id="qa_title" placeholder="Quick add: goal title" />
        <input id="qa_start" type="date" />
        <input id="qa_due" type="date" />
        <select id="qa_priority">
          <option>low</option><option selected>medium</option><option>high</option><option>critical</option>
        </select>
        <select id="qa_category"></select>
        <button id="qa_add" class="btn" type="button">Add</button>
      </div>

      <table>
        <thead><tr><th>ID</th><th>Title</th><th>Category</th><th>Start</th><th>Due</th><th>Priority</th><th>Status</th><th></th></tr></thead>
        <tbody id="goalRows"></tbody>
      </table>
    </div>

    <div class="muted" style="text-align:center;padding:18px">Data stored locally in your browser.</div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="backdrop" class="backdrop" aria-modal="true" role="dialog">
    <div class="modal" role="document">
      <header class="row" style="justify-content:space-between;">
        <h2 id="modalTitle">Add Goal</h2>
        <button id="closeModalBtn" class="btn secondary" type="button">Close</button>
      </header>
      <div class="grid">
        <div class="g12">
          <label for="m_title">Title</label>
          <input id="m_title" placeholder="e.g., Finish German A2 by March" />
          <div class="muted" id="m_title_error"></div>
        </div>
        <div class="g6">
          <label for="m_start">Start date</label>
          <input id="m_start" type="date" />
          <div class="muted" id="m_start_error"></div>
        </div>
        <div class="g6">
          <label for="m_due">Due date</label>
          <input id="m_due" type="date" />
          <div class="muted" id="m_due_error"></div>
        </div>
        <div class="g6">
          <label for="m_category">Category</label>
          <select id="m_category"></select>
        </div>
        <div class="g6">
          <label for="m_depends">Depends on</label>
          <select id="m_depends"><option value="">None</option></select>
        </div>
        <div class="g6">
          <label for="m_priority">Priority</label>
          <select id="m_priority">
            <option>low</option><option selected>medium</option><option>high</option><option>critical</option>
          </select>
        </div>
        <div class="g6">
          <label for="m_status">Status</label>
          <select id="m_status">
            <option>not_started</option><option>in_progress</option><option>blocked</option><option>done</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="saveBtn" class="btn" type="button" disabled>Save</button>
      </div>
    </div>
  </div>

  <!-- Settings (General, Categories, Data) -->
  <div id="settingsBackdrop" class="backdrop" aria-modal="true" role="dialog">
    <div class="modal" role="document">
      <header class="row" style="justify-content:space-between;">
        <h2>Settings</h2>
        <button id="closeSettingsBtn" class="btn secondary" type="button">Close</button>
      </header>

      <div class="toolbar" style="margin-bottom:8px;">
        <button class="btn secondary active" data-tab="tabGeneral" type="button">General</button>
        <button class="btn secondary" data-tab="tabCategories" type="button">Categories</button>
        <button class="btn secondary" data-tab="tabData" type="button">Data</button>
      </div>

      <div id="tabGeneral" style="display:block;">
        <div class="grid">
          <div class="g6">
            <label>Appearance</label>
            <select id="settingTheme"><option value="auto">Auto</option><option value="light">Light</option><option value="dark">Dark</option></select>
            <div class="muted">Theme is a placeholder for next pass.</div>
          </div>
          <div class="g6">
            <label>Density</label>
            <select id="settingDensity"><option value="cozy">Cozy</option><option value="compact">Compact</option></select>
            <div class="muted">Density is a placeholder for next pass.</div>
          </div>
        </div>
      </div>

      <div id="tabCategories" style="display:none;">
        <div id="categoryList" style="margin-bottom:16px;"></div>
        <div class="actions"><button id="addCategoryBtn" class="btn" type="button">Add Category</button></div>
      </div>

      <div id="tabData" style="display:none;">
        <div class="grid">
          <div class="g12">
            <label>Backup / Restore</label>
            <div class="row">
              <button id="settingsExportBtn" class="btn secondary" type="button">Export JSON</button>
              <button id="settingsImportBtn" class="btn secondary" type="button">Import JSON</button>
            </div>
          </div>
          <div class="g12" style="margin-top:12px;">
            <label>Danger zone</label>
            <button id="deleteAllBtn" class="btn warn" type="button">Delete EVERYTHING</button>
            <div class="muted">Removes all goals & categories from this browser. Cannot be undone.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===================== Utilities & Storage ===================== */
const $ = s => document.querySelector(s);
const goalsKey='focusone_goals', categoriesKey='focusone_categories';

function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function uid(){ return 'g_' + Math.random().toString(36).slice(2,9); }
function formatGoalID(i){ return 'G' + String(i).padStart(2,'0'); }

function loadGoals(){ try{ return JSON.parse(localStorage.getItem(goalsKey))||[] }catch{ return [] } }
function loadCategories(){ try{ return JSON.parse(localStorage.getItem(categoriesKey))||[] }catch{ return [] } }
function setGoals(v){ localStorage.setItem(goalsKey, JSON.stringify(v)); }
function setCategories(v){ localStorage.setItem(categoriesKey, JSON.stringify(v)); }

/* ===================== Defaults (safe) ===================== */
(function initDefaults(){
  if(loadCategories().length===0){
    setCategories([
      { id:uid(), name:'Wealth', color:'#4b5563' },
      { id:uid(), name:'Language', color:'#2563eb' },
      { id:uid(), name:'Immigration', color:'#d97706' },
      { id:uid(), name:'Career', color:'#16a34a' },
      { id:uid(), name:'Business', color:'#0d9488' },
      { id:uid(), name:'Health', color:'#dc2626' },
      { id:uid(), name:'Relationship', color:'#9333ea' },
      { id:uid(), name:'Real Estate', color:'#f59e0b' },
      { id:uid(), name:'Creative', color:'#f43f5e' },
      { id:uid(), name:'Other', color:'#6b7280' }
    ]);
  }
  if(loadGoals().length===0){
    const today=new Date();
    const inDays=d=>{ const x=new Date(today); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
    const catId=loadCategories()[0].id;
    setGoals([
      { id:uid(), title:'German A2 course',      start_date:inDays(0),   due_date:inDays(60),  categoryId:catId, priority:'high',    status:'in_progress' },
      { id:uid(), title:'SQM book — 2 chapters', start_date:inDays(7),   due_date:inDays(120), categoryId:catId, priority:'medium',  status:'not_started' },
      { id:uid(), title:'Gym — 52 sessions',     start_date:inDays(-14), due_date:inDays(168), categoryId:catId, priority:'critical',status:'not_started' }
    ]);
  }
})();

/* ===================== Global State ===================== */
let currentView='Month';
let filterYearTimeline='';
let filterYearTable='';
let lastUsedCategoryId=null;

/* ===================== Settings Modal ===================== */
const settingsBackdrop = $('#settingsBackdrop');
$('#openSettingsBtn').onclick=()=>{ switchTab('tabGeneral'); settingsBackdrop.classList.add('show'); };
$('#closeSettingsBtn').onclick=()=> settingsBackdrop.classList.remove('show');
const tabBtns = document.querySelectorAll('#settingsBackdrop .toolbar .btn');
tabBtns.forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function switchTab(id){
  tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  ['tabGeneral','tabCategories','tabData'].forEach(x=>{
    document.getElementById(x).style.display = (x===id?'block':'none');
  });
  if(id==='tabCategories') renderCategoryList();
}
$('#settingsExportBtn').onclick=()=>$('#exportJsonBtn').click();
$('#settingsImportBtn').onclick=()=>$('#importJsonBtn').click();
$('#deleteAllBtn').onclick=()=>{
  const sure=prompt('Type DELETE to remove ALL goals & categories.');
  if(sure==='DELETE'){
    localStorage.removeItem(goalsKey);
    localStorage.removeItem(categoriesKey);
    // re-seed minimal
    setCategories([{id:uid(), name:'Other', color:'#6b7280'}]);
    setGoals([]);
    refreshAll();
    alert('All data deleted.');
  }
};

/* ===================== Add/Edit Modal ===================== */
const backdrop=$('#backdrop'); let editingId=null;
const fields = {
  title:$('#m_title'), start:$('#m_start'), due:$('#m_due'),
  category:$('#m_category'), depends:$('#m_depends'),
  priority:$('#m_priority'), status:$('#m_status')
};
const errs={ title:$('#m_title_error'), start:$('#m_start_error'), due:$('#m_due_error') };
const saveBtn=$('#saveBtn');

function openModal(goal={}){
  editingId = goal.id || null;
  $('#modalTitle').textContent = editingId?'Edit Goal':'Add Goal';
  populateCategorySelect();
  populateDependsSelect();
  fields.title.value = goal.title||'';
  fields.start.value = goal.start_date||'';
  fields.due.value   = goal.due_date||'';
  fields.category.value = goal.categoryId || (lastUsedCategoryId || fields.category.value);
  fields.depends.value  = goal.dependsOnId || '';
  fields.priority.value = goal.priority || 'medium';
  fields.status.value   = goal.status || 'not_started';
  Object.values(errs).forEach(e=>e.textContent='');
  saveBtn.disabled=true;
  backdrop.classList.add('show');
  fields.title.focus();
}
function closeModal(){ backdrop.classList.remove('show'); editingId=null; saveBtn.disabled=true; }
$('#openAddBtn').onclick=()=>openModal();
$('#closeModalBtn').onclick=closeModal;
window.addEventListener('keydown',e=>{
  const anInput = /input|textarea|select/i.test((e.target||{}).tagName||'');
  if(e.key==='Escape'){ if(backdrop.classList.contains('show')) closeModal(); if(settingsBackdrop.classList.contains('show')) settingsBackdrop.classList.remove('show'); }
  if(!anInput && !backdrop.classList.contains('show') && !settingsBackdrop.classList.contains('show')){
    if(e.key==='n') openModal();
    if(e.key==='1') setView('Month');
    if(e.key==='2') setView('Quarter');
    if(e.key==='3') setView('Year');
    if(e.key==='/'){ e.preventDefault(); $('#searchBox').focus(); }
    if(e.key==='s') $('#openSettingsBtn').click();
  }
});

['m_start','m_due'].forEach(id=>{ const el=document.getElementById(id); el.addEventListener('change',()=>el.blur()); });

function populateCategorySelect(){
  const cats=loadCategories();
  fields.category.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(!fields.category.value){ const other=cats.find(c=>c.name==='Other')||cats[0]; if(other) fields.category.value=other.id; }
}
function populateDependsSelect(){
  const goals=loadGoals();
  fields.depends.innerHTML = `<option value="">None</option>` + goals.map(g=>`<option value="${g.id}">${escapeHtml(g.title)}</option>`).join('');
}
function validateForm(){
  let ok=true;
  if(!fields.title.value.trim()){ errs.title.textContent='Title is required.'; ok=false; } else errs.title.textContent='';
  if(!fields.start.value){ errs.start.textContent='Start date is required.'; ok=false; } else errs.start.textContent='';
  if(!fields.due.value){ errs.due.textContent='Due date is required.'; ok=false; }
  else if(fields.start.value && fields.start.value>fields.due.value){ errs.due.textContent='Due must be after start.'; ok=false; } else errs.due.textContent='';
  saveBtn.disabled=!ok;
}
Object.values(fields).forEach(el=>{ el.addEventListener('input',validateForm); el.addEventListener('change',validateForm); });
saveBtn.onclick=()=>{
  const d={
    title:fields.title.value.trim(),
    start_date:fields.start.value, due_date:fields.due.value,
    categoryId:fields.category.value, dependsOnId:fields.depends.value||null,
    priority:fields.priority.value, status:fields.status.value
  };
  lastUsedCategoryId = d.categoryId;
  const list=loadGoals();
  if(editingId) setGoals(list.map(g=>g.id===editingId?{...g,...d}:g));
  else { setGoals([...list, {id:uid(), ...d}]); }
  refreshAll();
  closeModal();
};

/* ===================== Manage Categories (Settings → Categories) ===================== */
function renderCategoryList(){
  const el=$('#categoryList'), cats=loadCategories();
  el.innerHTML = cats.map(c=>`
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <input class="cat-name" data-id="${c.id}" type="text" value="${escapeHtml(c.name)}" style="flex:1;padding:6px;border:1px solid var(--line);border-radius:6px;" />
      <input class="cat-color" data-id="${c.id}" type="color" value="${c.color}" />
      <button class="btn warn cat-del" data-id="${c.id}" type="button">Delete</button>
    </div>`).join('');
  el.querySelectorAll('.cat-name').forEach(inp=>inp.onchange=()=>{
    const id=inp.dataset.id; setCategories(loadCategories().map(c=>c.id===id?{...c,name:inp.value.trim()||c.name}:c)); refreshAll(); renderCategoryList();
  });
  el.querySelectorAll('.cat-color').forEach(inp=>inp.onchange=()=>{
    const id=inp.dataset.id; setCategories(loadCategories().map(c=>c.id===id?{...c,color:inp.value}:c)); refreshAll();
  });
  el.querySelectorAll('.cat-del').forEach(btn=>btn.onclick=()=>{
    if(!confirm('Delete this category and reassign goals to "Other"?')) return;
    const id=btn.dataset.id;
    let cats=loadCategories().filter(c=>c.id!==id);
    if(cats.length===0) cats=[{id:uid(),name:'Other',color:'#6b7280'}];
    const other=cats.find(c=>c.name==='Other')||cats[0];
    setCategories(cats);
    setGoals(loadGoals().map(g=>g.categoryId===id?{...g,categoryId:other.id}:g));
    refreshAll(); renderCategoryList();
  });
}
$('#addCategoryBtn').onclick=()=>{
  const name=prompt('New category name:'); if(!name) return;
  const color=prompt('Hex color (e.g. #1f2937):','#6b7280'); if(!/^#[0-9a-f]{6}$/i.test(color)) return alert('Invalid color');
  setCategories([...loadCategories(), {id:uid(), name:name.trim(), color}]); refreshAll(); renderCategoryList();
};

/* ===================== Export / Import ===================== */
$('#exportJsonBtn').onclick=()=>{
  const blob=new Blob([JSON.stringify({goals:loadGoals(), categories:loadCategories()}, null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='focusone-data.json'; a.click(); URL.revokeObjectURL(url);
};
$('#importJsonBtn').onclick=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange=()=>{
    const f=input.files[0]; if(!f) return; const fr=new FileReader();
    fr.onload=()=>{
      try{
        const d=JSON.parse(fr.result);
        if(Array.isArray(d.goals) && Array.isArray(d.categories)){
          if(confirm('Replace existing data?')){ setCategories(d.categories); setGoals(d.goals); }
          else {
            const cats0=loadCategories(); const mergedCats=[...cats0, ...d.categories.filter(c=>!cats0.find(x=>x.id===c.id))]; setCategories(mergedCats);
            const goals0=loadGoals(); const mergedGoals=[...goals0, ...d.goals.map(g=>({...g,id:uid()}))]; setGoals(mergedGoals);
          }
          refreshAll();
        } else alert('Invalid JSON format');
      }catch{ alert('Invalid JSON'); }
    };
    fr.readAsText(f);
  };
  input.click();
};

/* ===================== Filters: Search, Status, Priority, Year ===================== */
const searchBox=$('#searchBox'), filterStatus=$('#filterStatus'), filterPriority=$('#filterPriority');
const yearUI_tl=$('#yearFilterTimeline'), yearUI_tb=$('#yearFilterTable');

function buildYearUI(container, years, current, onChange){
  container.innerHTML=''; if(years.length===0) return;
  const MAX_BTN=8;
  if(years.length<=MAX_BTN){
    const bAll=document.createElement('button'); bAll.type='button'; bAll.className='btn year'+(current===''?' active':''); bAll.textContent='All';
    bAll.onclick=()=>{ onChange(''); container.querySelectorAll('.btn.year').forEach(b=>b.classList.remove('active')); bAll.classList.add('active'); };
    container.appendChild(bAll);
    years.forEach(y=>{
      const b=document.createElement('button'); b.type='button'; b.className='btn year'+(current===y?' active':''); b.dataset.year=y; b.textContent=y;
      b.onclick=()=>{ onChange(y); container.querySelectorAll('.btn.year').forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
      container.appendChild(b);
    });
  } else {
    const sel=document.createElement('select'); sel.className='btn secondary';
    sel.appendChild(new Option('All years','')); years.forEach(y=>sel.appendChild(new Option(y,y)));
    sel.value=current; sel.onchange=()=>onChange(sel.value);
    container.appendChild(sel);
  }
}
function rebuildYearFilters(){
  const years = Array.from(new Set(loadGoals().flatMap(g=>{
    const ys=[]; if(g.start_date) ys.push(g.start_date.slice(0,4)); if(g.due_date) ys.push(g.due_date.slice(0,4)); return ys;
  }))).sort();
  buildYearUI(yearUI_tl, years, filterYearTimeline, (v)=>{ filterYearTimeline=v; drawGantt(); });
  buildYearUI(yearUI_tb, years, filterYearTable,    (v)=>{ filterYearTable=v; renderTable(); });
}
$('#clearFiltersBtn').onclick=()=>{ searchBox.value=''; filterStatus.value=''; filterPriority.value=''; filterYearTimeline=''; filterYearTable=''; rebuildYearFilters(); renderTable(); drawGantt(); renderSummary(); };
searchBox.oninput=renderTable; filterStatus.onchange=renderTable; filterPriority.onchange=renderTable;

/* ===================== Quick Add ===================== */
const qa={ title:$('#qa_title'), start:$('#qa_start'), due:$('#qa_due'), prio:$('#qa_priority'), cat:$('#qa_category'), add:$('#qa_add') };
(function initQuick(){
  const today=new Date(); const pad=n=>String(n).padStart(2,'0');
  const dstr=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const start=new Date(); const due=new Date(); due.setDate(start.getDate()+30);
  qa.start.value=dstr(start); qa.due.value=dstr(due);
  const cats=loadCategories(); qa.cat.innerHTML=cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(lastUsedCategoryId) qa.cat.value=lastUsedCategoryId;
})();
qa.add.onclick=()=>{
  const title=qa.title.value.trim(); if(!title) return alert('Title is required.');
  if(!qa.start.value || !qa.due.value) return alert('Set both start & due.');
  if(qa.start.value>qa.due.value) return alert('Start must be before or equal Due.');
  const g={ id:uid(), title, start_date:qa.start.value, due_date:qa.due.value, priority:qa.prio.value, categoryId:qa.cat.value, status:'not_started' };
  setGoals([...loadGoals(), g]); lastUsedCategoryId=g.categoryId; qa.title.value=''; refreshAll();
};

/* ===================== Table (render + inline edit) ===================== */
function formatIdMap(list){ // stable numbering by created order
  return new Map(list.map((g,i)=>[g.id, formatGoalID(i+1)]));
}
function renderTable(){
  const cats=loadCategories(), fs=filterStatus.value, fp=filterPriority.value, fy=filterYearTable;
  const q=(searchBox.value||'').toLowerCase();
  const list = loadGoals().filter(g=>{
    if(q){
      const cat = cats.find(c=>c.id===g.categoryId)?.name || '';
      if(!g.title.toLowerCase().includes(q) && !cat.toLowerCase().includes(q)) return false;
    }
    if(fs && g.status!==fs) return false;
    if(fp && g.priority!==fp) return false;
    if(fy){
      const sy=g.start_date?.slice(0,4), dy=g.due_date?.slice(0,4); if(sy!==fy && dy!==fy) return false;
    }
    return true;
  });
  const tbody=$('#goalRows');
  if(list.length===0){ tbody.innerHTML='<tr><td colspan="8" class="no-data">No goals match your filters.</td></tr>'; return; }
  const idMap = formatIdMap(loadGoals());
  tbody.innerHTML = list.map(g=>{
    const cat=cats.find(c=>c.id===g.categoryId)||{name:'Other',color:'#6b7280'};
    return `<tr data-id="${g.id}">
      <td>${idMap.get(g.id)}</td>
      <td data-field="title">${escapeHtml(g.title)}</td>
      <td data-field="categoryId"><span class="category-pill" style="background:${cat.color}">${escapeHtml(cat.name)}</span></td>
      <td data-field="start_date">${g.start_date||''}</td>
      <td data-field="due_date">${g.due_date||''}</td>
      <td data-field="priority"><span class="pill prio-${g.priority}">${g.priority}</span></td>
      <td data-field="status"><span class="pill status-${g.status}">${g.status.replace('_',' ')}</span></td>
      <td class="row" style="gap:4px;">
        <button class="btn secondary" data-edit="${g.id}" type="button">Edit</button>
        <button class="btn warn" data-del="${g.id}" type="button">Delete</button>
      </td>
    </tr>`;
  }).join('');

  // Click -> Modal edit
  tbody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=e=>{
    e.stopPropagation(); const id=b.dataset.edit; const g=loadGoals().find(x=>x.id===id); if(g) openModal(g);
  });
  tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick=e=>{
    e.stopPropagation(); const id=b.dataset.del;
    if(confirm('Delete this goal?')){ setGoals(loadGoals().filter(g=>g.id!==id)); refreshAll(); }
  });

  // Inline edit (double click)
  tbody.querySelectorAll('td[data-field]').forEach(td=>{
    td.ondblclick = () => startInlineEdit(td);
  });
}
function startInlineEdit(td){
  const tr=td.closest('tr'); const id=tr.dataset.id; const field=td.dataset.field;
  const goals=loadGoals(); const g=goals.find(x=>x.id===id); if(!g) return;

  let editor;
  const commit = (val)=>{
    const updated={...g, [field]:val};
    if(updated.start_date && updated.due_date && updated.start_date>updated.due_date){
      alert('Start must be before or equal Due.'); renderTable(); return;
    }
    setGoals(goals.map(x=>x.id===id?updated:x)); refreshAll();
  };
  const cancel = ()=> renderTable();

  if(field==='title'){
    editor=document.createElement('input'); editor.value=g.title; editor.style.width='100%';
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value.trim()); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value.trim());
    td.innerHTML=''; td.appendChild(editor); editor.focus(); editor.select();
  } else if(field==='start_date' || field==='due_date'){
    editor=document.createElement('input'); editor.type='date'; editor.value=g[field]||''; editor.style.width='100%';
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='priority'){
    editor=document.createElement('select'); ['low','medium','high','critical'].forEach(p=>editor.appendChild(new Option(p,p,p===g.priority,p===g.priority)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='status'){
    const opts=['not_started','in_progress','blocked','done'];
    editor=document.createElement('select'); opts.forEach(p=>editor.appendChild(new Option(p,p,p===g.status,p===g.status)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  } else if(field==='categoryId'){
    editor=document.createElement('select'); loadCategories().forEach(c=>editor.appendChild(new Option(c.name,c.id,c.id===g.categoryId,c.id===g.categoryId)));
    editor.onkeydown=(e)=>{ if(e.key==='Enter') commit(editor.value); if(e.key==='Escape') cancel(); };
    editor.onblur=()=>commit(editor.value);
    td.innerHTML=''; td.appendChild(editor); editor.focus();
  }
}

/* ===================== Status (pills + mini donut) ===================== */
function renderSummary(){
  const list=loadGoals(); const today=new Date().toISOString().slice(0,10);
  const done=list.filter(g=>g.status==='done').length;
  const blocked=list.filter(g=>g.status==='blocked').length;
  const inprog=list.filter(g=>g.status==='in_progress').length;
  const notStarted=list.filter(g=>g.status==='not_started').length;
  const overdue=list.filter(g=>g.due_date && g.due_date<today && g.status!=='done').length;
  $('#statusSummary').innerHTML = `
    <span class="pill status-done">Done: ${done}</span>
    <span class="pill status-in_progress">In progress: ${inprog}</span>
    <span class="pill status-blocked">Blocked: ${blocked}</span>
    <span class="pill status-not_started">Not started: ${notStarted}</span>
    <span class="pill prio-high">Overdue: ${overdue}</span>`;

  // Mini donut
  const canvas=document.getElementById('statusMini'); const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const values=[notStarted,inprog,blocked,done]; const colors=['#e2e8f0','#8b5cf6','#111827','#22c55e'];
  const total=values.reduce((a,b)=>a+b,0);
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-4, inner=r*0.6;
  let start=-Math.PI/2;
  if(total===0){ ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#e5e7eb'; ctx.fill(); }
  else {
    values.forEach((v,i)=>{ const a=(v/total)*2*Math.PI; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+a); ctx.closePath(); ctx.fillStyle=colors[i]; ctx.fill(); start+=a; });
  }
  // hole
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
  const pct = total? Math.round((done/total)*100):0; ctx.fillStyle='#0f172a'; ctx.font='700 16px system-ui,-apple-system,Segoe UI,Roboto,sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(pct+'%', cx, cy);
}

/* ===================== Timeline (SVG) ===================== */
function setView(v){ currentView=v; document.querySelectorAll('#viewButtons button').forEach(b=>b.classList.toggle('view-active', b.dataset.view===v)); drawGantt(); }
document.getElementById('viewButtons').addEventListener('click', e=>{
  if(e.target.matches('button[data-view]')) setView(e.target.dataset.view);
});
function daysBetween(a,b){ return Math.max(0, Math.ceil((new Date(b)-new Date(a))/86400000)); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function monthLabel(x){ return x.toLocaleString(undefined,{month:'short',year:'numeric'}); }

function drawGantt(){
  const cont=$('#gantt'), countEl=$('#ganttCount');
  let items=loadGoals().filter(g=>g.start_date && g.due_date);
  if(filterYearTimeline){
    items = items.filter(g=>{
      const sy=g.start_date.slice(0,4), dy=g.due_date.slice(0,4);
      return (sy===filterYearTimeline || dy===filterYearTimeline);
    });
  }
  cont.innerHTML='';
  if(items.length===0){ cont.innerHTML='<div class="no-data">No items to plot.</div>'; countEl.textContent='Items: 0'; return; }
  countEl.textContent='Items: '+items.length;

  let min=items[0].start_date, max=items[0].due_date;
  items.forEach(g=>{ if(g.start_date<min) min=g.start_date; if(g.due_date>max) max=g.due_date; });

  const pad=(currentView==='Year'?30:(currentView==='Quarter'?14:7));
  const minPad=addDays(min,-pad), maxPad=addDays(max,pad);
  const total=daysBetween(minPad,maxPad);
  const pxPerDay=(currentView==='Year'?4:(currentView==='Quarter'?8:16));
  const height=60 + items.length*32, width=120 + total*pxPerDay;

  const NS='http://www.w3.org/2000/svg';
  const svg=document.createElementNS(NS,'svg');
  svg.setAttribute('width',Math.max(width, cont.clientWidth));
  svg.setAttribute('height',height);

  // Grid
  const step=(currentView==='Month'?7:(currentView==='Quarter'?14:30));
  for(let i=0;i<=total;i+=step){
    const d=addDays(minPad,i), x=100 + i*pxPerDay;
    const l=document.createElementNS(NS,'line'); l.setAttribute('x1',x); l.setAttribute('y1',24); l.setAttribute('x2',x); l.setAttribute('y2',height);
    l.setAttribute('stroke','#e2e8f0'); l.setAttribute('stroke-width','1'); svg.appendChild(l);
    const t=document.createElementNS(NS,'text'); t.setAttribute('x',x+4); t.setAttribute('y',16); t.setAttribute('class','axis');
    t.textContent=(currentView==='Month')? d.toLocaleDateString(undefined,{month:'short',day:'numeric'}) : monthLabel(d);
    svg.appendChild(t);
  }

  // Today marker
  const now=new Date();
  if(now>=new Date(minPad) && now<=new Date(maxPad)){
    const off=daysBetween(minPad,now)*pxPerDay, x=100+off;
    const l=document.createElementNS(NS,'line'); l.setAttribute('x1',x); l.setAttribute('y1',24); l.setAttribute('x2',x); l.setAttribute('y2',height);
    l.setAttribute('stroke','#ef4444'); l.setAttribute('stroke-width','2'); l.setAttribute('stroke-dasharray','4 2'); svg.appendChild(l);
    const t=document.createElementNS(NS,'text'); t.setAttribute('x',x+4); t.setAttribute('y',16); t.setAttribute('class','axis'); t.textContent='Today'; svg.appendChild(t);
  }

  const cats=loadCategories();
  items.forEach((g,i)=>{
    const y=36 + i*32;
    // label
    const t=document.createElementNS(NS,'text'); t.setAttribute('x','8'); t.setAttribute('y',y+12); t.setAttribute('class','label'); t.textContent=g.title; svg.appendChild(t);
    // bar
    const startOff=daysBetween(minPad, new Date(g.start_date));
    const barX=100 + startOff*pxPerDay;
    const barW=Math.max(6, daysBetween(new Date(g.start_date), new Date(g.due_date)) * pxPerDay);
    const rect=document.createElementNS(NS,'rect');
    rect.setAttribute('x',barX); rect.setAttribute('y',y); rect.setAttribute('width',barW); rect.setAttribute('height',20); rect.setAttribute('rx',6); rect.setAttribute('ry',6);
    const cat=cats.find(c=>c.id===g.categoryId)||{color:'#6b7280'};
    rect.setAttribute('fill',cat.color); rect.setAttribute('fill-opacity', g.status==='done'?'0.7':'1.0');
    rect.setAttribute('stroke','#0f172a22'); rect.setAttribute('stroke-width','1'); rect.style.cursor='pointer';
    rect.onclick=()=>{ const g0=loadGoals().find(x=>x.id===g.id); if(g0) openModal(g0); };
    svg.appendChild(rect);
  });

  cont.appendChild(svg);
}

/* ===================== Year filters build ===================== */
function rebuildYearFilters(){
  const years = Array.from(new Set(loadGoals().flatMap(g=>{
    const ys=[]; if(g.start_date) ys.push(g.start_date.slice(0,4)); if(g.due_date) ys.push(g.due_date.slice(0,4)); return ys;
  }))).sort();
  buildYearUI(yearUI_tl, years, filterYearTimeline, (v)=>{ filterYearTimeline=v; drawGantt(); });
  buildYearUI(yearUI_tb, years, filterYearTable,    (v)=>{ filterYearTable=v; renderTable(); });
}

/* ===================== Refresh ===================== */
function refreshAll(){
  // refresh quick add category list (preserve selection if possible)
  const cats=loadCategories();
  const sel=qa_categoryPopulate(cats);
  if(lastUsedCategoryId) $('#qa_category').value = lastUsedCategoryId;
  rebuildYearFilters();
  renderTable();
  drawGantt();
  renderSummary();
}
function qa_categoryPopulate(cats){
  const el=$('#qa_category'); const cur=el.value;
  el.innerHTML = cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
  if(cur) el.value=cur;
}

/* ===================== Boot ===================== */
document.addEventListener('DOMContentLoaded', refreshAll);
</script>
</body>
</html>
